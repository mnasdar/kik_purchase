import{f as T}from"./index-a4e39586.js";import{i as M}from"./id-7a0d5e4f.js";import{s as m,d as $,c as B}from"./notification-d92c8c7c.js";import"./_commonjsHelpers-725317a4.js";import"./notification-5f085df9.js";let g=[],h=[],v=new Set,p=1;const x=10;document.addEventListener("DOMContentLoaded",function(){H(),N(),F(),P()});function H(){const e=document.querySelector(".flatpickr-submit-date");e&&T(e,{locale:M.Indonesian,dateFormat:"d M Y",altInput:!0,altFormat:"d M Y",allowInput:!0,onChange:function(t){t.length>0&&Q()}})}function N(){const e=document.getElementById("btn-pick-invoice"),t=document.getElementById("btn-close-invoice-modal"),n=document.getElementById("invoice-search-input"),o=document.getElementById("btn-invoice-prev"),c=document.getElementById("btn-invoice-next"),a=document.getElementById("btn-save-invoice-selection"),i=document.getElementById("invoice-select-all");e&&e.addEventListener("click",R),t&&t.addEventListener("click",D),n&&n.addEventListener("input",O),o&&o.addEventListener("click",()=>goToPage(p-1)),c&&c.addEventListener("click",()=>goToPage(p+1)),a&&a.addEventListener("click",z),i&&i.addEventListener("change",Y)}function F(){const e=document.getElementById("form-create-pengajuan");e&&e.addEventListener("submit",V);const t=document.getElementById("btn-delete-selected-items");t&&t.addEventListener("click",W)}function P(){const e=document.getElementById("item-select-all");e&&e.addEventListener("change",X)}async function R(){const e=document.getElementById("modal-pick-invoice");if(e){e.classList.remove("hidden"),document.body.style.overflow="hidden";try{await J(),I()}catch(t){console.error("Error loading invoices:",t),m("Gagal memuat data invoice. Silakan coba lagi.","error")}}}function D(){const e=document.getElementById("modal-pick-invoice");if(!e)return;e.classList.add("hidden"),document.body.style.overflow="";const t=document.getElementById("invoice-search-input");t&&(t.value="");const n=document.getElementById("invoice-select-all");n&&(n.checked=!1),h=[...g],p=1}async function J(){try{const e=await fetch("/invoice/pengajuan/get-invoices");if(!e.ok)throw new Error("Network response was not ok");g=(await e.json()).data||[],h=[...g]}catch(e){throw console.error("Fetch error:",e),e}}function O(e){const t=e.target.value.toLowerCase().trim();t?h=g.filter(n=>{var o,c,a,i,s,r,l;return((o=n.invoice_number)==null?void 0:o.toLowerCase().includes(t))||((a=(c=n.purchase_order)==null?void 0:c.po_number)==null?void 0:a.toLowerCase().includes(t))||((r=(s=(i=n.purchase_order)==null?void 0:i.purchase_request)==null?void 0:s.pr_number)==null?void 0:r.toLowerCase().includes(t))||((l=n.item_description)==null?void 0:l.toLowerCase().includes(t))}):h=[...g],p=1,I()}function I(){const e=document.getElementById("invoice-list-body");if(!e)return;const t=h.length,n=Math.ceil(t/x),o=(p-1)*x,c=Math.min(o+x,t),a=h.slice(o,c);document.getElementById("invoice-count").textContent=t,document.getElementById("invoice-total").textContent=g.length,document.getElementById("invoice-current-page").textContent=p,document.getElementById("invoice-total-pages").textContent=n||1,document.getElementById("invoice-per-page").textContent=x;const i=document.getElementById("btn-invoice-prev"),s=document.getElementById("btn-invoice-next");if(i&&(i.disabled=p<=1),s&&(s.disabled=p>=n),e.innerHTML="",a.length===0){e.innerHTML=`
            <tr>
                <td colspan="9" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                    <i class="mgc_inbox_line text-3xl mb-2"></i>
                    <p class="text-sm">Tidak ada invoice yang tersedia</p>
                </td>
            </tr>
        `;return}a.forEach(r=>{var E,y,b;const l=document.createElement("tr");l.className="border-b hover:bg-gray-50 dark:hover:bg-slate-700/50";const f=v.has(r.id),d=parseFloat(r.unit_price)||0,u=parseFloat(r.qty)||0,_=d*u;l.innerHTML=`
            <td class="px-3 py-2 text-center">
                <input type="checkbox" class="form-checkbox rounded text-primary invoice-checkbox" data-invoice-id="${r.id}" ${f?"checked":""}>
            </td>
            <td class="px-3 py-2">
                <span class="text-sm font-semibold text-blue-600 dark:text-blue-400">${r.invoice_number||"-"}</span>
            </td>
            <td class="px-3 py-2">
                <span class="text-sm">${((E=r.purchase_order)==null?void 0:E.po_number)||"-"}</span>
            </td>
            <td class="px-3 py-2">
                <span class="text-sm">${((b=(y=r.purchase_order)==null?void 0:y.purchase_request)==null?void 0:b.pr_number)||"-"}</span>
            </td>
            <td class="px-3 py-2">
                <span class="text-sm">${r.item_description||"-"}</span>
            </td>
            <td class="px-3 py-2 text-right">
                <span class="text-sm">${k(d)}</span>
            </td>
            <td class="px-3 py-2 text-center">
                <span class="text-sm">${u}</span>
            </td>
            <td class="px-3 py-2 text-right">
                <span class="text-sm font-semibold">${k(_)}</span>
            </td>
        `,e.appendChild(l)}),e.querySelectorAll(".invoice-checkbox").forEach(r=>{r.addEventListener("change",L)})}function L(){const e=document.querySelectorAll("#invoice-list-body .invoice-checkbox:checked"),t=document.getElementById("btn-save-invoice-selection"),n=document.getElementById("invoice-select-all");if(t){const o=e.length;t.innerHTML=`
            <i class="mgc_check_line me-2"></i>
            Simpan Pilihan${o>0?` (${o})`:""}
        `,t.disabled=o===0}if(n){const o=document.querySelectorAll("#invoice-list-body .invoice-checkbox").length;o>0&&(n.checked=e.length===o)}}function Y(e){const t=e.target.checked;document.querySelectorAll("#invoice-list-body .invoice-checkbox").forEach(o=>{o.checked=t}),L()}function z(){const e=document.querySelectorAll("#invoice-list-body .invoice-checkbox:checked");if(e.length===0){m("Silakan pilih minimal 1 invoice","warning");return}let t=0;e.forEach(n=>{const o=parseInt(n.dataset.invoiceId);if(v.has(o))return;const c=g.find(a=>a.id===o);c&&(v.add(o),K(c),t++)}),t>0&&m(`${t} invoice berhasil ditambahkan`,"success"),D()}function K(e){var y,b,w;const t=document.getElementById("pengajuan-items-container"),n=document.getElementById("pengajuan-item-row-template");if(!t||!n)return;t.querySelector("tr:first-child td[colspan]")&&(t.innerHTML="");const a=n.content.cloneNode(!0).querySelector(".pengajuan-item-row"),i=t.children.length+1;a.querySelector(".pengajuan-item-number").textContent=i,a.querySelector(".pengajuan-invoice-id").value=e.id,a.querySelector(".pengajuan-invoice-number").textContent=e.invoice_number||"-",a.querySelector(".pengajuan-po-number").textContent=((y=e.purchase_order)==null?void 0:y.po_number)||"-",a.querySelector(".pengajuan-pr-number").textContent=((w=(b=e.purchase_order)==null?void 0:b.purchase_request)==null?void 0:w.pr_number)||"-",a.querySelector(".pengajuan-item-desc").textContent=e.item_description||"-";const s=parseFloat(e.unit_price)||0,r=parseFloat(e.qty)||0,l=s*r;a.querySelector(".pengajuan-unit-price").textContent=k(s),a.querySelector(".pengajuan-qty").textContent=r,a.querySelector(".pengajuan-amount").textContent=k(l);const f=e.invoice_received_at?Z(e.invoice_received_at):"-";a.querySelector(".pengajuan-received-date").textContent=f,a.querySelector(".pengajuan-sla-target").textContent=`${e.sla_target} Hari`;const d=a.querySelector(".pengajuan-sla-realisasi"),u=document.querySelector(".flatpickr-submit-date");if(d&&u&&u._flatpickr&&e.invoice_received_at){const q=u._flatpickr.selectedDates[0];if(q){const j=A(e.invoice_received_at,q);d.textContent=j==="-"?"-":`${j} Hari`}else d.textContent="-"}else d&&(d.textContent="-");a.dataset.invoiceData=JSON.stringify(e),a.querySelector(".pengajuan-btn-remove-item").addEventListener("click",()=>G(e.id,a)),a.querySelector(".item-checkbox").addEventListener("change",S),t.appendChild(a),C()}async function G(e,t){var i;const n=((i=t.querySelector(".pengajuan-invoice-number"))==null?void 0:i.textContent)||"invoice ini";if(!await $(`invoice <strong>${n}</strong>`))return;v.delete(e),t.remove(),m(`Invoice ${n} berhasil dihapus dari daftar`,"success"),C();const c=document.getElementById("pengajuan-items-container");c&&c.children.length===0&&(c.innerHTML=`
            <tr class="text-center text-gray-500">
                <td colspan="13" class="border px-4 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="mgc_inbox_line text-4xl text-gray-400"></i>
                        <p class="text-sm">Belum ada invoice yang dipilih</p>
                        <p class="text-xs text-gray-400">Klik tombol "Pilih Invoice" untuk memulai</p>
                    </div>
                </td>
            </tr>
        `),S();const a=document.getElementById("modal-pick-invoice");a&&!a.classList.contains("hidden")&&I()}function C(){const e=document.getElementById("pengajuan-items-container");if(!e)return;e.querySelectorAll(".pengajuan-item-row").forEach((n,o)=>{const c=n.querySelector(".pengajuan-item-number");c&&(c.textContent=o+1)})}function X(e){const t=e.target.checked;document.querySelectorAll(".item-checkbox").forEach(o=>{o.checked=t}),S()}function S(){const e=document.querySelectorAll(".item-checkbox:checked"),t=document.getElementById("btn-delete-selected-items"),n=document.getElementById("selected-items-count");if(t&&n){const c=e.length;c>0?(t.classList.remove("hidden"),n.textContent=c):(t.classList.add("hidden"),n.textContent="0")}const o=document.getElementById("item-select-all");if(o){const c=document.querySelectorAll(".item-checkbox"),a=c.length>0&&c.length===e.length;o.checked=a}}async function W(){const e=document.querySelectorAll(".item-checkbox:checked");if(e.length===0||!await B(`Anda akan menghapus ${e.length} invoice dari daftar`,"Hapus Invoice Terpilih?"))return;let n=0;e.forEach(a=>{const i=a.closest(".pengajuan-item-row");if(i){const s=parseInt(i.querySelector(".pengajuan-invoice-id").value);v.delete(s),i.remove(),n++}}),m(`${n} invoice berhasil dihapus dari daftar`,"success"),C();const o=document.getElementById("pengajuan-items-container");o&&o.children.length===0&&(o.innerHTML=`
            <tr class="text-center text-gray-500">
                <td colspan="13" class="border px-4 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="mgc_inbox_line text-4xl text-gray-400"></i>
                        <p class="text-sm">Belum ada invoice yang dipilih</p>
                        <p class="text-xs text-gray-400">Klik tombol "Pilih Invoice" untuk memulai</p>
                    </div>
                </td>
            </tr>
        `),S();const c=document.getElementById("modal-pick-invoice");c&&!c.classList.contains("hidden")&&I()}function Q(){const e=document.getElementById("pengajuan-items-container");if(!e)return;const t=document.querySelector(".flatpickr-submit-date");if(!t||!t._flatpickr)return;const n=t._flatpickr.selectedDates[0];if(!n)return;e.querySelectorAll(".pengajuan-item-row").forEach(c=>{const a=JSON.parse(c.dataset.invoiceData||"{}"),i=c.querySelector(".pengajuan-sla-target");if(i){const r=a.sla_target||5;i.textContent=`${r} Hari`}const s=c.querySelector(".pengajuan-sla-realisasi");if(s)if(a.invoice_received_at){const r=A(a.invoice_received_at,n);s.textContent=r==="-"?"-":`${r} Hari`}else s.textContent="-"})}function A(e,t){try{const n=new Date(e),o=new Date(t);if(isNaN(n.getTime())||isNaN(o.getTime())||(n.setHours(0,0,0,0),o.setHours(0,0,0,0),o<n))return"-";const c=new Date(n);c.setDate(c.getDate()+1);let a=0;for(;c<=o;){const i=c.getDay();i!==0&&i!==6&&(a+=1),c.setDate(c.getDate()+1)}return a}catch(n){return console.error("Error calculating business-day SLA:",n),"-"}}function U(e){const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${o}`}async function V(e){e.preventDefault();const t=document.getElementById("pengajuan-items-container"),n=document.querySelector(".flatpickr-submit-date"),o=e.target,c=o.querySelector('button[type="submit"]'),a=c?c.innerHTML:"";let i=null;if(n&&n._flatpickr&&n._flatpickr.selectedDates.length>0)i=n._flatpickr.selectedDates[0];else if(n!=null&&n.value){const l=new Date(n.value);isNaN(l.getTime())||(i=l)}if(!n||!i)return m("Tanggal pengajuan harus diisi","warning"),n.focus(),!1;if(!t||t.querySelectorAll(".pengajuan-item-row").length===0)return m("Belum ada invoice yang dipilih","warning"),!1;const s=t.querySelectorAll(".pengajuan-item-row").length;if(!await B(`Anda akan mengajukan ${s} invoice ke finance`,"Ajukan Invoice?"))return!1;c&&(c.disabled=!0,c.innerHTML='<span class="loading loading-spinner loading-sm me-2"></span>Menyimpan...');try{const l=new FormData(o);i&&l.set("invoice_submitted_at",U(i));const f=await fetch(o.action,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},body:l});let d=null;try{d=await f.json()}catch(u){console.error("Failed to parse response JSON:",u)}if(!f.ok||d&&d.success===!1){const u=ee(d)||"Gagal menyimpan pengajuan";return m(u,"error"),!1}m((d==null?void 0:d.message)||"Pengajuan berhasil disimpan","success"),setTimeout(()=>{window.location.href="/invoice/pengajuan"},600)}catch(l){return console.error("Error submitting pengajuan:",l),m("Terjadi kesalahan saat menyimpan. Silakan coba lagi.","error"),!1}finally{c&&(c.disabled=!1,c.innerHTML=a)}}function k(e){return new Intl.NumberFormat("id-ID",{minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function Z(e){try{const t=new Date(e),n=String(t.getDate()).padStart(2,"0"),c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()],a=String(t.getFullYear()).slice(-2);return`${n}-${c}-${a}`}catch{return"-"}}function ee(e){if(!e)return null;if(e.message)return e.message;if(e.errors&&typeof e.errors=="object"){const t=Object.keys(e.errors)[0];if(t&&Array.isArray(e.errors[t])&&e.errors[t].length>0)return e.errors[t][0]}return null}
