import{f as U}from"./index-a4e39586.js";import{A as w}from"./AutoNumericPredefinedOptions-22c6ad49.js";import{a as b,c as V,b as T,d as g}from"./notification-0e55581f.js";import{s as O}from"./index-88056f3d.js";import{$ as e}from"./jquery-2823516c.js";import{N as Y}from"./nice-select2-6e0cfbe7.js";import"./pembayaran-edit-5f085df9.js";import"./_commonjsHelpers-725317a4.js";import"./parse-c3570fb2.js";let L=0,c={},f=[];function G(t,a=null){let n=typeof t=="string"?new Date(t+"T00:00:00"):new Date(t),i=a?typeof a=="string"?new Date(a+"T00:00:00"):new Date(a):new Date;n=new Date(n.getFullYear(),n.getMonth(),n.getDate()),i=new Date(i.getFullYear(),i.getMonth(),i.getDate());let o=0,r=new Date(n);for(;r<=i;){const s=r.getDay();s>=1&&s<=5&&o++,r.setDate(r.getDate()+1)}return o}function M(t){if(t==null||t==="")return"-";const a=Number(t)||0;return new Intl.NumberFormat("id-ID").format(a)}function J(t){if(!t)return"-";try{const a=new Date(t+"T00:00:00");return new Intl.DateTimeFormat("id-ID",{day:"2-digit",month:"short",year:"2-digit"}).format(a)}catch{return t}}e(document).ready(function(){e("#supplier_id").each(function(){new Y(this,{searchable:!0})})});function Q(){if(document.querySelector("style[data-po-create]"))return;const t=`
input[type="number"].po-item-quantity{padding-right:0 !important;}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{
    -webkit-appearance:none;
    margin:0;
    padding:0;
    width:40px;
    height:100%;
    background:#f3f4f6;
    border-left:1px solid #e5e7eb;
    cursor:pointer;
}
input[type="number"]::-webkit-outer-spin-button{border-bottom:1px solid #e5e7eb;}
input[type="number"]::-webkit-inner-spin-button{border-top:1px solid #e5e7eb;}
input[type="number"]{-moz-appearance:textfield;}
`,a=document.createElement("style");a.setAttribute("data-po-create","true"),a.textContent=t,document.head.appendChild(a)}function X(){e("#form-create-po").length&&(Q(),Z(),pt(),tt(),it(),at())}function Z(){U("#approved_date",{altInput:!0,altFormat:"d-M-y",dateFormat:"Y-m-d",allowInput:!0,locale:{firstDayOfWeek:1},onChange:function(t,a,n){I(a)&&z(a)}})}function I(t){if(!t||t.trim()==="")return!0;const a=new Date(t+"T00:00:00");let n=!1,i="",o="";if(e("#po-items-container .po-item-row").each(function(){const r=e(this),s=r.find(".po-pr-approved-date").attr("data-pr-approved-date"),u=r.find(".po-pr-number").val();if(s&&s.trim()!==""){const d=new Date(s+"T00:00:00");if(a<d)return n=!0,i=u,o=s,!1}}),n){e("#approved_date").val("");const r=document.querySelector("#approved_date");return r&&r._flatpickr&&r._flatpickr.clear(),b(`⚠️ Tanggal PO Approve (${t}) tidak boleh lebih kecil dari tanggal PR Approve (${o}) pada PR ${i}. Silakan isi kembali tanggal PO Approve yang valid.`),setTimeout(()=>{e("#approved_date").focus()},100),z(""),!1}return!0}function z(t){if(!t||t.trim()===""){e("#po-items-container .po-item-row").each(function(){e(this).find('input[name*="sla_pr_to_po_realization"]').val("")});return}e("#po-items-container .po-item-row").each(function(){const a=e(this),n=a.find(".po-pr-approved-date").attr("data-pr-approved-date");if(n&&n.trim()!==""){const i=G(n,t);a.find('input[name*="sla_pr_to_po_realization"]').val(i)}else a.find('input[name*="sla_pr_to_po_realization"]').val("")})}function tt(){e(document).on("click",".po-btn-remove-item",function(){e(this).closest("tr").remove(),W(),C(),H(),N(),f.length>0&&S(f)}),e(document).on("input",".po-item-quantity",function(){const t=e(this).closest("tr");A(t)}),et(),e(document).on("click","#btn-delete-selected-items",function(){nt()})}function et(){e(document).off("change","#item-select-all").on("change","#item-select-all",function(){const t=e(this).prop("checked");e(".item-checkbox").prop("checked",t),D()}),e(document).off("change",".item-checkbox").on("change",".item-checkbox",function(){const t=e(".item-checkbox").length,a=e(".item-checkbox:checked").length;e("#item-select-all").prop("checked",t===a),D()})}function D(){const t=e(".item-checkbox:checked").length,a=e("#btn-delete-selected-items");t>0?(a.removeClass("hidden"),e("#selected-items-count").text(t)):a.addClass("hidden")}async function nt(){const t=e(".item-checkbox:checked").closest("tr"),a=t.length;if(a===0){b("Pilih minimal 1 item untuk dihapus");return}await V(`Apakah Anda yakin ingin menghapus ${a} item terpilih?`,"Konfirmasi Hapus")&&(t.remove(),W(),C(),e("#item-select-all").prop("checked",!1),D(),H(),N(),f.length>0&&S(f),T(`${a} item berhasil dihapus`))}function at(){e("#request_type").on("change",function(){const t=e(this).val(),a=e("#btn-pick-pr"),n=e("#po-items-container tr").not(".text-center.text-gray-500");t?(a.prop("disabled",!1),n.length>0&&e("#request_type").prop("disabled",!0)):a.prop("disabled",!0)})}function N(){const t=e("#po-items-container tr").not(".text-center.text-gray-500"),a=e("#request_type");t.length>0?a.prop("disabled",!0):a.prop("disabled",!1)}function it(){e(document).on("click","#btn-pick-pr",async function(){await rt(),ct()}),e(document).on("click","#btn-close-pr-modal",function(){F()}),e(document).on("click",".btn-select-pr",function(){const t=e(this).data("pr-id"),a=f.find(n=>n.id===t);if(!a){g("PR tidak ditemukan");return}lt(a),F()})}async function rt(){try{const t=e("#request_type").val();if(!t){b("Pilih Request Type terlebih dahulu");return}const a=await fetch(O("purchase-order.pr-list"),{headers:{Accept:"application/json"}}),n=await a.json();if(!a.ok){g(n.message||"Gagal memuat PR");return}if(f=(n.data||[]).filter(i=>i.request_type===t),f.length===0){b(`Tidak ada PR dengan tipe "${t}" yang tersedia`),F();return}S(f)}catch(t){console.error(t),g("Gagal memuat PR")}}let E=[],p=1,$=10,h=[];function S(t){E=t;const a=[];if(e("#po-items-container .po-pr-item-id").each(function(){const n=e(this).val();n&&a.push(parseInt(n))}),h=t.map(n=>{const i=n.items.filter(o=>!a.includes(o.id));return{...n,available_items_count:i.length}}).filter(n=>n.available_items_count>0),p=1,e("#pr-total").text(h.length),!h.length){e("#pr-list-body").html('<tr><td colspan="5" class="px-3 py-3 text-center text-gray-500">Semua item dari PR sudah ditambahkan ke tabel</td></tr>'),e("#pr-count").text(0),K();return}R(p),ot(),st()}function R(t){const a=(t-1)*$,n=a+$,i=h.slice(a,n),o=e("#pr-list-body");if(o.empty(),!i.length){o.append('<tr><td colspan="6" class="px-3 py-3 text-center text-gray-500">Tidak ada PR yang sesuai</td></tr>');return}i.forEach(r=>{const s=r.available_items_count||0,u=r.location_name||"-",d=r.formatted_approved_date||"-",l=r.request_type||"",y=l?`<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold ${l==="barang"?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400":"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400"}">${l.charAt(0).toUpperCase()+l.slice(1)}</span>`:"-";o.append(`
            <tr class="border-b last:border-0 pr-row" data-pr-number="${r.pr_number}" data-location="${u}">
                <td class="px-3 py-2 font-semibold text-gray-800 dark:text-gray-100">${r.pr_number}</td>
                <td class="px-3 py-2 text-gray-600 dark:text-gray-300">${y}</td>
                <td class="px-3 py-2 text-gray-600 dark:text-gray-300">${u}</td>
                <td class="px-3 py-2 text-gray-600 dark:text-gray-300">${d}</td>
                <td class="px-3 py-2 text-center">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                        <i class="mgc_check_line"></i>
                        ${s} tersedia
                    </span>
                </td>
                <td class="px-3 py-2 text-center">
                    <button type="button" class="btn btn-sm bg-primary text-white hover:bg-primary-600 btn-select-pr" data-pr-id="${r.id}">
                        Pilih
                    </button>
                </td>
            </tr>
        `)}),e("#pr-count").text(i.length),K()}function K(){const t=Math.ceil(h.length/$)||1;e("#pr-current-page").text(p),e("#pr-total-pages").text(t),e("#pr-per-page").text($),e("#btn-pr-prev").prop("disabled",p<=1),e("#btn-pr-next").prop("disabled",p>=t)}function ot(){e(document).off("input","#pr-search-input").on("input","#pr-search-input",function(){const t=e(this).val().toLowerCase().trim();if(t){const a=[];e("#po-items-container .po-pr-item-id").each(function(){const n=e(this).val();n&&a.push(parseInt(n))}),h=E.filter(n=>{const i=(n.pr_number||"").toLowerCase(),o=(n.location_name||"").toLowerCase();return i.includes(t)||o.includes(t)}).map(n=>{const i=n.items.filter(o=>!a.includes(o.id));return{...n,available_items_count:i.length}}).filter(n=>n.available_items_count>0)}else{const a=[];e("#po-items-container .po-pr-item-id").each(function(){const n=e(this).val();n&&a.push(parseInt(n))}),h=E.map(n=>{const i=n.items.filter(o=>!a.includes(o.id));return{...n,available_items_count:i.length}}).filter(n=>n.available_items_count>0)}p=1,e("#pr-total").text(h.length),R(p)})}function st(){e(document).off("click","#btn-pr-prev").on("click","#btn-pr-prev",function(){p>1&&(p--,R(p),e("#pr-list-body").closest(".overflow-x-auto").scrollTop(0))}),e(document).off("click","#btn-pr-next").on("click","#btn-pr-next",function(){const t=Math.ceil(h.length/$);p<t&&(p++,R(p),e("#pr-list-body").closest(".overflow-x-auto").scrollTop(0))})}function ct(){e("#modal-pick-pr").removeClass("hidden")}function F(){e("#modal-pick-pr").addClass("hidden")}function lt(t){if(!t||!Array.isArray(t.items)){b("PR tidak memiliki item");const i=e("#approved_date").val().trim();if(i&&t.approved_date_raw){const o=new Date(i+"T00:00:00");if(new Date(t.approved_date_raw+"T00:00:00")>o){e("#approved_date").val("");const s=document.querySelector("#approved_date");s&&s._flatpickr&&s._flatpickr.clear(),b(`⚠️ Tanggal PR Approve (${t.approved_date_raw}) pada PR ${t.pr_number} lebih besar dari tanggal PO Approve (${i}). Silakan isi kembali tanggal PO Approve yang valid (minimal ${t.approved_date_raw}).`),setTimeout(()=>{e("#approved_date").focus()},100),z("")}}return}e("#po-items-container tr.text-center.text-gray-500").remove();const a=[];e("#po-items-container .po-pr-item-id").each(function(){const i=e(this).val();i&&a.push(parseInt(i))});let n=0;if(t.items.forEach(i=>{a.includes(i.id)||(B({id:i.id,pr_number:t.pr_number,item_desc:i.item_desc,uom:i.uom,unit_price:i.unit_price,quantity:i.quantity,amount:i.amount,cost_saving:i.cost_saving??0,approved_date:t.approved_date_raw}),n++)}),n===0){b(`Semua item dari PR ${t.pr_number} sudah ada dalam tabel`);return}S(f),C(),e("#item-select-all").prop("checked",!1),D(),e("#approved-date-container").removeClass("hidden"),N(),T(`${n} item dari PR ${t.pr_number} berhasil ditambahkan`)}function B(t=null){const a=e("#po-item-row-template").html(),n=e(a),i=L++;n.attr("data-row-id",i),n.find("input, select").each(function(){const x=e(this).attr("name");if(x){const P=x.replace(/\[\d+\]/,`[${i}]`);e(this).attr("name",P)}}),e("#po-items-container").append(n);const o=n.attr("data-row-id"),r=n.find('input[name$="[unit_price]"]')[0],s=n.find('input[name$="[amount]"]')[0],u=n.find(".po-pr-item-id")[0],d=n.find(".po-pr-desc")[0],l=n.find(".po-pr-uom")[0],y=n.find(".po-pr-amount")[0],m=n.find(".po-pr-unit-price-display"),v=n.find(".po-pr-qty-display"),k=n.find(".po-pr-amount-display");r&&(c[`unit_price_${o}`]=new w(r,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),e(r).on("input keyup blur autoNumeric:rawValueModified",function(){A(n)}),t!=null&&t.unit_price&&c[`unit_price_${o}`].set(t.unit_price)),s&&(c[`amount_${o}`]=new w(s,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),t!=null&&t.amount&&c[`amount_${o}`].set(t.amount)),y&&(t!=null&&t.amount)&&e(y).val(t.amount),m&&(t==null?void 0:t.unit_price)!==void 0&&m.text(M(t.unit_price)),v&&(t==null?void 0:t.quantity)!==void 0&&v.text(t.quantity),k&&(t==null?void 0:t.amount)!==void 0&&k.text(M(t.amount)),u&&e(u).val((t==null?void 0:t.id)??""),d&&e(d).val((t==null?void 0:t.item_desc)??""),l&&e(l).val((t==null?void 0:t.uom)??"");const _=n.find(".po-pr-number")[0],q=n.find(".po-pr-number-display");if(_&&(t!=null&&t.pr_number)&&e(_).val(t.pr_number),q.length&&(t!=null&&t.pr_number)&&q.text(t.pr_number).removeClass("text-gray-400").addClass("text-blue-600 dark:text-blue-400"),t!=null&&t.quantity&&n.find(".po-item-quantity").val(t.quantity),t!=null&&t.approved_date&&(n.find(".po-pr-approved-date").attr("data-pr-approved-date",t.approved_date),n.find(".po-pr-approved-date-display").text(J(t.approved_date))),(t==null?void 0:t.sla_pr_to_po_target)!==void 0&&(t==null?void 0:t.sla_pr_to_po_target)!==null&&n.find('input[name*="sla_pr_to_po_target"]').val(t.sla_pr_to_po_target),(t==null?void 0:t.sla_pr_to_po_realization)!==void 0&&(t==null?void 0:t.sla_pr_to_po_realization)!==null)n.find('input[name*="sla_pr_to_po_realization"]').val(t.sla_pr_to_po_realization);else{const x=e("#approved_date").val().trim();if(x&&(t!=null&&t.approved_date)){const P=G(t.approved_date,x);n.find('input[name*="sla_pr_to_po_realization"]').val(P)}}A(n),C()}function W(){Object.keys(c).forEach(t=>{try{c[t]&&c[t].remove()}catch(a){console.warn("AutoNumeric removal warning:",a.message)}}),c={},e("#po-items-container tr").each(function(t){const a=e(this);let n=a.attr("data-row-id");n||(n=++L,a.attr("data-row-id",n));const i=a.find('input[name$="[unit_price]"]')[0],o=a.find('input[name$="[amount]"]')[0];if(i){if(i){const r=w.getAutoNumericElement(i);r?c[`unit_price_${n}`]=r:c[`unit_price_${n}`]=new w(i,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),e(i).off("input keyup blur autoNumeric:rawValueModified change").on("input keyup blur autoNumeric:rawValueModified change",function(){A(a)})}if(o){const r=w.getAutoNumericElement(o);r?c[`amount_${n}`]=r:c[`amount_${n}`]=new w(o,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"})}}})}function C(){e("#po-items-container tr").each(function(t){e(this).hasClass("text-gray-500")||e(this).find(".po-item-number").text(t+1)})}function H(){if(e("#po-items-container tr").not(".text-center.text-gray-500").length===0){const a=`
            <tr class="text-center text-gray-500">
                <td colspan="12" class="py-8">
                    <i class="mgc_inbox_line text-3xl mb-2"></i>
                    <p class="font-semibold">Klik "Ambil Data PR" untuk memuat items dari Purchase Request</p>
                    <p class="text-sm mt-1 text-amber-600 dark:text-amber-400">⚠️ Items harus diambil dari PR (minimal 1 item)</p>
                </td>
            </tr>
        `;e("#po-items-container").html(a),e("#approved-date-container").addClass("hidden"),e("#approved_date").val("");const n=document.querySelector("#approved_date");n&&n._flatpickr&&n._flatpickr.clear(),N(),f.length>0&&S(f)}}function ut(t){Object.keys(t).forEach(a=>{const n=e(`#error-${a}`);n.length&&n.text(t[a][0]).removeClass("hidden")})}function j(t){e(`#error-${t}`).text("").addClass("hidden")}function dt(){e('[id^="error-"]').text("").addClass("hidden")}function A(t){const a=t.attr("data-row-id"),n=parseFloat(t.find(".po-item-quantity").val())||0,i=c[`unit_price_${a}`],o=c[`amount_${a}`];if(!i||!o)return;const r=i.getNumber()||0,s=n*r;o.set(s)}function pt(){e("#form-create-po").on("submit",async function(t){t.preventDefault(),dt();const a=mt();if(!a.isValid){g(a.message);return}if(!await V("Data purchase order akan disimpan ke sistem.","Konfirmasi Simpan"))return;const i=e(this).find('button[type="submit"]'),o=i.html();i.prop("disabled",!0).html('<i class="mgc_loading_line animate-spin me-2"></i>Menyimpan...');try{const r=new FormData(this),s=[];e("#po-items-container tr").not(".text-center.text-gray-500").each(function(y){const m=e(this),v=m.attr("data-row-id"),k=c[`unit_price_${v}`],_=c[`amount_${v}`],q=k?k.getNumber():0,x=_?_.getNumber():0,P=parseFloat(m.find(".po-pr-amount").val())||0;s.push({purchase_request_item_id:m.find(".po-pr-item-id").val()||null,pr_amount:P,unit_price:q,quantity:parseInt(m.find(".po-item-quantity").val())||0,amount:x,sla_po_to_onsite_target:m.find('input[name*="sla_po_to_onsite_target"]').val()||null,sla_pr_to_po_realization:m.find('input[name*="sla_pr_to_po_realization"]').val()||null})}),r.append("items",JSON.stringify(s));const d=await fetch(e(this).attr("action"),{method:"POST",headers:{Accept:"application/json"},body:r}),l=await d.json();if(!d.ok){l.errors&&ut(l.errors),g(l.message||"Gagal menyimpan PO");return}T("PO berhasil disimpan"),window.location.href=O("purchase-order.index")}catch(r){console.error("Error:",r),g("Terjadi kesalahan: "+r.message)}finally{i.prop("disabled",!1).html(o)}})}function mt(){const t=e("#po_number").val().trim(),a=e("#request_type").val(),n=e("#approved_date").val().trim(),i=e("#supplier_id").val(),o=e("#po-items-container tr").not(".text-center.text-gray-500"),r=o.length;if(!t)return{isValid:!1,message:"PO Number harus diisi"};if(!a)return{isValid:!1,message:"Request Type harus dipilih"};if(!n)return{isValid:!1,message:"Approved Date harus diisi"};if(!i)return{isValid:!1,message:"Supplier harus dipilih"};if(r===0)return{isValid:!1,message:"Minimal harus ada 1 item dari PR. Klik 'Ambil Data PR' untuk menambah item."};let s=!0,u="";return o.each(function(d){const l=e(this),y=l.attr("data-row-id"),m=c[`unit_price_${y}`],v=parseFloat(l.find(".po-item-quantity").val())||0,k=m?m.getNumber():0,_=l.find('input[name*="sla_po_to_onsite_target"]').val();if(k<=0)return s=!1,u=`Item ${d+1}: Harga satuan harus lebih dari 0`,!1;if(v<=0)return s=!1,u=`Item ${d+1}: Quantity harus lebih dari 0`,!1;if(!_||_===""||parseFloat(_)<=0)return s=!1,u=`Item ${d+1}: SLA Target harus diisi dan lebih dari 0`,!1}),s?{isValid:!0}:{isValid:!1,message:u}}async function ft(t){try{const a=await fetch(O("purchase-order.checkDeletedItem"),{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")},body:JSON.stringify({po_number:t})}),n=await a.json();if(!a.ok){console.error("Error checking deleted PO:",n);return}n.has_deleted_item&&n.deleted_item&&(await V(`PO Number "${t}" sudah pernah diinput sebelumnya dan telah dihapus. Apakah Anda ingin mengaktifkan kembali data tersebut?`,"Data Sudah Pernah Diinput")?await _t(n.deleted_item):(e("#po_number").val("").focus(),e("#error-po_number").text("PO Number sudah pernah diinput sebelumnya. Silakan gunakan nomor lain atau aktifkan data yang sudah ada.").removeClass("hidden")))}catch(a){console.error("Error checking deleted PO:",a)}}async function _t(t){try{const a=b("Mengaktifkan kembali data PO..."),n=await fetch(O("purchase-order.restore",{purchase_order:t.id}),{method:"POST",headers:{Accept:"application/json","X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")}}),i=await n.json();if(!n.ok){g(i.message||"Gagal mengaktifkan kembali PO");return}ht(t),T("PO berhasil diaktifkan kembali. Data telah dimuat ke form.")}catch(a){console.error("Error restoring PO:",a),g("Terjadi kesalahan saat mengaktifkan PO")}}function ht(t){e("#po_number").val(t.po_number),e("#approved_date").val(t.approved_date);const a=e("#supplier_id")[0];if(a&&t.supplier_id){e(a).val(t.supplier_id);const i=new Event("change",{bubbles:!0});a.dispatchEvent(i)}e("#notes").val(t.notes||""),e("#po-items-container tr.text-center.text-gray-500").remove(),e("#po-items-container tr").remove(),t.items&&Array.isArray(t.items)&&t.items.forEach(i=>{B({id:i.purchase_request_item_id,pr_number:i.pr_number,item_desc:i.item_desc,uom:i.uom,unit_price:i.unit_price,quantity:i.quantity,amount:i.amount,pr_amount:i.pr_amount,pr_unit_price:i.pr_unit_price,pr_quantity:i.pr_quantity,sla_po_to_onsite_target:i.sla_po_to_onsite_target,sla_pr_to_po_realization:i.sla_pr_to_po_realization,approved_date:i.approved_date})}),C(),e("#item-select-all").prop("checked",!1),D(),e("#approved-date-container").removeClass("hidden");const n=document.querySelector("#approved_date");n&&n._flatpickr&&t.approved_date&&n._flatpickr.setDate(t.approved_date,!0)}function bt(){e("#po_number").on("input",function(){j("po_number")}),e("#supplier_id").on("change",function(){j("supplier_id")}),e("#po_number").on("blur",async function(){const t=e(this).val().trim();t&&await ft(t)})}e(document).ready(function(){X(),bt()});
