import{s as f,c as S}from"./notification-d92c8c7c.js";import{s as P}from"./index-88056f3d.js";import{$ as t}from"./modal-handler-2823516c.js";import{A as h}from"./AutoNumericPredefinedOptions-22c6ad49.js";import{f as D}from"./index-a4e39586.js";import"./notification-5f085df9.js";import"./_commonjsHelpers-725317a4.js";import"./parse-c3570fb2.js";let v=0,s={};function C(){if(document.querySelector("style[data-po-create]"))return;const e=`
input[type="number"].po-item-quantity{padding-right:0 !important;}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{
    -webkit-appearance:none;
    margin:0;
    padding:0;
    width:40px;
    height:100%;
    background:#f3f4f6;
    border-left:1px solid #e5e7eb;
    cursor:pointer;
}
input[type="number"]::-webkit-outer-spin-button{border-bottom:1px solid #e5e7eb;}
input[type="number"]::-webkit-inner-spin-button{border-top:1px solid #e5e7eb;}
input[type="number"]{-moz-appearance:textfield;}
`,n=document.createElement("style");n.setAttribute("data-po-create","true"),n.textContent=e,document.head.appendChild(n)}function N(){t("#form-edit-pr").length&&(R(),q(),F(),O(),C())}function O(){t("#items-container tr").each(function(e){const n=t(this),a=n.find('input[name*="unit_price"]')[0],r=n.find('input[name*="amount"]')[0];if(a){const m=t(a).val().replace(/\./g,"").replace(/,/g,".");s[`unit_price_${e}`]=new h(a,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),s[`unit_price_${e}`].set(parseFloat(m)||0),t(a).on("change",function(){g(n)})}if(r){const m=t(r).val().replace(/\./g,"").replace(/,/g,".");s[`amount_${e}`]=new h(r,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),s[`amount_${e}`].set(parseFloat(m)||0)}}),v=t("#items-container tr").length}function q(){t("#btn-add-item").on("click",function(){V()}),t(document).on("click",".btn-remove-item",function(){const e=t(this).closest("tr");if(t("#items-container tr").length<=1){f("Minimal harus ada 1 item","warning",2e3);return}e.remove(),x(),$()}),t(document).on("input",".item-quantity",function(){const e=t(this).closest("tr");g(e)}),t(document).on("blur",".item-quantity",async function(){const e=t(this).closest("tr"),n=parseFloat(t(this).val());n&&n>0&&!e.attr("data-item-id")&&await M(e)})}function F(){D("#approved_date",{altInput:!0,altFormat:"d-M-y",dateFormat:"Y-m-d",allowInput:!0,defaultDate:t("#approved_date").val()||null,locale:{firstDayOfWeek:1}})}function V(){const e=t("#item-row-template").html(),n=t(e),a=v++;n.find("select, input").each(function(){const c=t(this).attr("name");c&&t(this).attr("name",c.replace("[0]",`[${a}]`))}),t("#items-container").append(n);const r=n.index(),m=n.find('input[name*="unit_price"]')[0],o=n.find('input[name*="amount"]')[0];m&&(s[`unit_price_${r}`]=new h(m,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),t(m).on("change",function(){g(n)})),o&&(s[`amount_${r}`]=new h(o,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"})),$()}function x(){Object.keys(s).forEach(e=>{s[e]&&(s[e].remove(),delete s[e])}),t("#items-container tr").each(function(e){const n=t(this),a=n.find('input[name*="unit_price"]')[0],r=n.find('input[name*="amount"]')[0];a&&!s[`unit_price_${e}`]&&(s[`unit_price_${e}`]=new h(a,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),t(a).on("change",function(){g(n)})),r&&!s[`amount_${e}`]&&(s[`amount_${e}`]=new h(r,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}))})}function $(){t("#items-container tr").each(function(e){t(this).find(".item-number").text(e+1),t(this).find("select, input").each(function(){const n=t(this).attr("name");n&&t(this).attr("name",n.replace(/\[\d+\]/,`[${e}]`))})})}function T(e){Object.keys(e).forEach(n=>{const a=t(`#error-${n}`);a.length&&a.text(e[n][0]).removeClass("hidden")})}function E(e){t(`#error-${e}`).text("").addClass("hidden")}function A(){t('[id^="error-"]').text("").addClass("hidden")}function g(e){const n=e.index(),a=parseFloat(e.find(".item-quantity").val())||0,r=s[`unit_price_${n}`],m=s[`amount_${n}`];if(!r||!m)return;const o=r.getNumber()||0,c=a*o;m.set(c)}function R(){t("#form-edit-pr").on("submit",async function(e){var o,c;e.preventDefault(),A();const n=j();if(!n.isValid){f(n.message,"error",3e3);return}if(!await S("Data purchase request akan diperbarui.","Konfirmasi Update"))return;const r=t(this).find('button[type="submit"]'),m=r.html();r.prop("disabled",!0).html('<i class="mgc_loading_line animate-spin me-2"></i>Memperbarui...');try{Object.values(s).forEach(u=>{const p=u.getNumber(),b=u.domElement||u.input||u.element;b&&(b.value=p)});const i=new FormData(this),l=[];t("#items-container tr").each(function(){const u=t(this).attr("data-restore-item-id");u&&l.push(u)}),l.length>0&&i.append("restore_item_ids",JSON.stringify(l));const d=await t.ajax({url:t(this).attr("action"),method:"POST",data:i,processData:!1,contentType:!1,headers:{"X-CSRF-TOKEN":t('meta[name="csrf-token"]').attr("content")}});f("Purchase request berhasil diperbarui!","success",2e3),setTimeout(()=>{window.location.href=P("purchase-request.index")},500)}catch(i){if(console.error("Error:",i),i.status===422&&((o=i.responseJSON)!=null&&o.errors))T(i.responseJSON.errors),f("Periksa kembali form Anda","error",3e3);else{const l=((c=i.responseJSON)==null?void 0:c.message)||"Terjadi kesalahan saat memperbarui data";f(l,"error",3e3)}r.prop("disabled",!1).html(m)}})}function j(){var l;const e=t("#pr_number").val().trim(),n=t("#location_id").val(),a=t("#items-container tr").length,r=(l=t("#approved_date").val())==null?void 0:l.trim(),m=t("#request_type").val().trim();if(!e)return{isValid:!1,message:"PR Number harus diisi"};if(!n)return{isValid:!1,message:"Location harus diisi"};if(a===0)return{isValid:!1,message:"Minimal harus ada 1 item"};if(!r)return{isValid:!1,message:"Approved Date harus diisi"};if(!m)return{isValid:!1,message:"Request Type harus diisi"};let o=!0,c="";const i=[];if(t("#items-container tr").each(function(d){t(this).find('select[name*="classification_id"]').val();const u=t(this).find('input[name*="item_desc"]').val().trim(),p=t(this).find('input[name*="uom"]').val().trim(),b=parseFloat(t(this).find('input[name*="quantity"]').val())||0,k=t(this).index(),_=s[`unit_price_${k}`],I=_?_.getNumber():0;if(!u)return o=!1,c=`Item #${d+1}: Item Description harus diisi`,!1;if(!p)return o=!1,c=`Item #${d+1}: UOM harus diisi`,!1;if(I<=0)return o=!1,c=`Item #${d+1}: Unit Price harus lebih dari 0`,!1;if(b<=0)return o=!1,c=`Item #${d+1}: Quantity harus lebih dari 0`,!1;const y=t(this).find('input[name*="sla_pr_to_po_target"]').val(),w=y!=null&&y!==""?parseInt(y,10):NaN;if(Number.isNaN(w)||w<0)return o=!1,c=`Item #${d+1}: SLA PRâ†’PO Target (hari) wajib diisi dan >= 0`,!1;i.push({index:d+1,itemDesc:u.toLowerCase(),uom:p.toLowerCase(),unitPrice:I})}),o){for(let d=0;d<i.length;d++)for(let u=d+1;u<i.length;u++)if(i[d].itemDesc===i[u].itemDesc&&i[d].uom===i[u].uom&&i[d].unitPrice===i[u].unitPrice)return o=!1,c=`Item #${i[d].index} dan #${i[u].index} memiliki Item Description, UOM, dan Unit Price yang sama (duplikat)`,{isValid:!1,message:c}}return o?{isValid:!0}:{isValid:!1,message:c}}async function M(e){const n=e.find('input[name*="item_desc"]').val().trim(),a=e.find('input[name*="uom"]').val().trim(),r=e.index(),m=s[`unit_price_${r}`],o=m?m.getNumber():0,c=t("#pr_number").val().trim();if(!(!n||!a||!o||o<=0||!c))try{const i=await t.ajax({url:P("purchase-request.checkDeletedItem"),method:"POST",data:{pr_number:c,item_desc:n,uom:a,unit_price:o},headers:{"X-CSRF-TOKEN":t('meta[name="csrf-token"]').attr("content")}});if(i.has_deleted_item&&i.deleted_item){const l=i.deleted_item;if(await S(`Data item "${l.item_desc}" dengan UOM "${l.uom}" dan Unit Price ${new Intl.NumberFormat("id-ID").format(l.unit_price)} pernah diinput sebelumnya.

Apakah Anda ingin mengaktifkan kembali data tersebut?`,"Item Pernah Diinput",{confirmButtonText:"Ya, Aktifkan Kembali",cancelButtonText:"Tidak, Input Manual",showCancelButton:!0})){l.classification_id&&e.find('select[name*="classification_id"]').val(l.classification_id);const u=e.find('input[name*="quantity"]'),p=s[`amount_${r}`];u.val(l.quantity),p&&p.set(l.amount),e.attr("data-restore-item-id",l.id),e.addClass("restore-item"),f("Data berhasil diisi dari riwayat sebelumnya","success",2e3)}}}catch(i){console.error("Error checking deleted item:",i)}}function U(){t("#pr_number").on("input",function(){E("pr_number")})}t(document).ready(function(){N(),U()});
