import{$ as e}from"./modal-handler-2823516c.js";import{f as M}from"./index-a4e39586.js";import{a as f,c as R,b as S}from"./notification-d92c8c7c.js";import"./_commonjsHelpers-725317a4.js";import"./notification-5f085df9.js";let F=0,u=[],m=[],D=!1,r=new Set;function g(t){if(t==null||t==="")return"-";const n=Number(t)||0;return new Intl.NumberFormat("id-ID").format(n)}function x(){r.clear(),e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const t=Number(e(this).val());!Number.isNaN(t)&&t>0&&r.add(t)})}function A(t,n){if(!t||!n)return 0;const a=new Date(t),c=new Date(n);if(a.setHours(0,0,0,0),c.setHours(0,0,0,0),c<a)return 0;let o=0;const s=new Date(a);for(;s<=c;){const i=s.getDay();i!==0&&i!==6&&o++,s.setDate(s.getDate()+1)}return o}function T(){e("#form-create-pembayaran").length&&(q(),O(),ee(),x())}function q(){e(document).on("click",".pembayaran-btn-remove-item",function(){const t=e(this).closest("tr");t.find(".pembayaran-invoice-id").val();const n=t.attr("data-row-id"),a=m.findIndex(c=>c.rowId===n);a!==-1&&(m[a].instance&&m[a].instance.destroy(),m.splice(a,1)),t.remove(),$(),L(),x(),u.length>0&&N(u)}),B(),e(document).on("click","#btn-delete-selected-items",function(){H()}),ne()}function B(){e(document).off("change","#item-select-all").on("change","#item-select-all",function(){e(".item-checkbox").prop("checked",this.checked),k()}),e(document).off("change",".item-checkbox").on("change",".item-checkbox",function(){const t=e(".item-checkbox").length===e(".item-checkbox:checked").length;e("#item-select-all").prop("checked",t),k()})}function k(){const t=e(".item-checkbox:checked").length,n=e("#btn-delete-selected-items");t>0?(n.removeClass("hidden"),e("#selected-items-count").text(t)):n.addClass("hidden")}async function H(){const t=e(".item-checkbox:checked").closest("tr"),n=t.length;if(n===0){f("Tidak ada item yang dipilih");return}await R(`Apakah Anda yakin ingin menghapus ${n} item terpilih?`,"Konfirmasi Hapus")&&(t.each(function(){const c=e(this).attr("data-row-id"),o=m.findIndex(s=>s.rowId===c);o!==-1&&(m[o].instance&&m[o].instance.destroy(),m.splice(o,1))}),t.remove(),$(),x(),e("#item-select-all").prop("checked",!1),k(),L(),u.length>0&&N(u),S(`${n} item berhasil dihapus`))}function O(){e(document).off("click","#btn-pick-invoice").on("click","#btn-pick-invoice",async function(){x(),V(),await j(),J(),y()}),e(document).off("click","#btn-close-invoice-modal").on("click","#btn-close-invoice-modal",function(){C()}),e(document).off("click","#btn-close-invoice-modal-footer").on("click","#btn-close-invoice-modal-footer",function(){C()}),e(document).off("change",".invoice-row-checkbox").on("change",".invoice-row-checkbox",function(){const t=Number(e(this).data("invoice-id"));this.checked?r.add(t):r.delete(t),_(),y()}),e(document).off("change","#invoice-select-all").on("change","#invoice-select-all",function(){const t=e(".invoice-row-checkbox"),n=e(this).is(":checked");t.each(function(){const a=Number(e(this).data("invoice-id"));n?r.add(a):r.delete(a),e(this).prop("checked",n)}),y()}),e(document).off("click","#btn-apply-selected-invoices").on("click","#btn-apply-selected-invoices",function(){W()})}let w=[],d=1,v=10,l=[];async function j(){try{const t=await fetch("/invoice/pembayaran/get-invoices",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}});if(!t.ok)throw new Error("Gagal memuat data invoice");const n=await t.json();u=n,N(n)}catch(t){console.error("Error loading invoices:",t),f("Gagal memuat data invoice"),P()}}function y(){const t=new Set;e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const a=Number(e(this).val());!Number.isNaN(a)&&a>0&&t.add(a)});const n=Array.from(r).filter(a=>!t.has(a)).length;e("#invoice-selected-count").text(n),e("#btn-apply-count").text(n),e("#btn-apply-selected-invoices").prop("disabled",n===0)}function W(){const t=new Set;e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const a=Number(e(this).val());!Number.isNaN(a)&&a>0&&t.add(a)});const n=[];if(r.forEach(a=>{if(!t.has(a)){const c=u.find(o=>Number(o.id)===a);c&&n.push(c)}}),n.length===0){f("Pilih minimal 1 invoice baru");return}n.forEach(a=>{Q(a)}),x(),N(u),y(),C()}function N(t){const n=new Set;if(e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const a=Number(e(this).val());!Number.isNaN(a)&&a>0&&n.add(a)}),w=t,l=[...w],n.forEach(a=>r.add(a)),d=1,e("#invoice-total").text(l.length),!l.length){e("#invoice-list-body").html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang tersedia
                </td>
            </tr>
        `);return}I(d),K(),Y(),P(),z()}function I(t){const n=(t-1)*v,a=n+v,c=l.slice(n,a),o=e("#invoice-list-body");if(o.empty(),!c.length){o.html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang cocok dengan pencarian
                </td>
            </tr>
        `);return}const s=new Set;e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const i=Number(e(this).val());!Number.isNaN(i)&&i>0&&s.add(i)}),c.forEach(i=>{const h=r.has(Number(i.id)),p=s.has(Number(i.id)),b=p?"disabled":"",E=`
            <tr class="${p?"bg-gray-100 dark:bg-slate-700/50 opacity-60":"hover:bg-gray-50 dark:hover:bg-slate-700/30"}">
                <td class="px-3 py-2 text-center">
                    <input type="checkbox" class="form-checkbox rounded text-primary invoice-row-checkbox" data-invoice-id="${i.id}" ${h?"checked":""} ${b} title="${p?"Sudah ditambahkan":""}">
                </td>
                <td class="px-3 py-2 text-left">
                    <span class="font-medium text-blue-600 dark:text-blue-400">${i.invoice_number}</span>
                </td>
                <td class="px-3 py-2 text-left">${i.po_number}</td>
                <td class="px-3 py-2 text-left">${i.pr_number}</td>
                <td class="px-3 py-2 text-left text-xs">${i.item_desc}</td>
                <td class="px-3 py-2 text-right">${g(i.unit_price)}</td>
                <td class="px-3 py-2 text-center">${i.quantity??"-"}</td>
                <td class="px-3 py-2 text-right font-semibold">${g(i.amount)}</td>
            </tr>
        `;o.append(E)}),G(),e("#invoice-count").text(c.length),X(),_()}function X(){const t=Math.ceil(l.length/v)||1;e("#invoice-current-page").text(d),e("#invoice-total-pages").text(t),e("#invoice-per-page").text(v),e("#btn-invoice-prev").prop("disabled",d<=1),e("#btn-invoice-next").prop("disabled",d>=t)}function G(){e(document).off("change",".invoice-row-checkbox").on("change",".invoice-row-checkbox",function(t){if(e(this).is(":disabled"))return t.preventDefault(),!1;const n=Number(e(this).data("invoice-id"));this.checked?r.add(n):r.delete(n),_(),y()})}function _(){const t=e(".invoice-row-checkbox");if(!t.length){e("#invoice-select-all").prop("checked",!1);return}const n=e(".invoice-row-checkbox:checked").length;e("#invoice-select-all").prop("checked",n>0&&n===t.length)}function J(){e(".invoice-row-checkbox").each(function(){const t=Number(e(this).data("invoice-id"));e(this).prop("checked",r.has(t))}),_()}function K(){e(document).off("input","#invoice-search-input").on("input","#invoice-search-input",function(){const t=e(this).val().toLowerCase().trim();t===""?l=[...w]:l=w.filter(n=>(n.invoice_number||"").toLowerCase().includes(t)||(n.po_number||"").toLowerCase().includes(t)||(n.pr_number||"").toLowerCase().includes(t)||(n.item_desc||"").toLowerCase().includes(t)),d=1,e("#invoice-total").text(l.length),I(d)})}function Y(){e(document).off("click","#btn-invoice-prev").on("click","#btn-invoice-prev",function(){d>1&&(d--,I(d))}),e(document).off("click","#btn-invoice-next").on("click","#btn-invoice-next",function(){const t=Math.ceil(l.length/v);d<t&&(d++,I(d))})}function z(){e("#modal-pick-invoice").removeClass("hidden")}function C(){e("#modal-pick-invoice").addClass("hidden")}function V(){e("#invoice-page-loading").removeClass("hidden")}function P(){e("#invoice-page-loading").addClass("hidden")}function Q(t,n={}){e("#pembayaran-items-container tr.text-center.text-gray-500").remove();const a=[];e("#pembayaran-items-container tr.pembayaran-item-row .pembayaran-invoice-id").each(function(){const c=e(this).val(),o=Number(c);!Number.isNaN(o)&&o>0&&a.push(o)}),!a.includes(Number(t.id))&&(U(t),r.add(Number(t.id)),$(),e("#item-select-all").prop("checked",!1),k())}function U(t){const n=e("#pembayaran-item-row-template").html(),a=e(n),c=F++,o="row-"+c;a.attr("data-row-id",o),a.find("input, select").each(function(){const i=e(this).attr("name");i&&e(this).attr("name",i.replace("[0]",`[${c}]`))}),e("#pembayaran-items-container").append(a),a.find(".pembayaran-invoice-id").val(t.id),a.find(".pembayaran-invoice-number").text(t.invoice_number),a.find(".pembayaran-po-number").text(t.po_number),a.find(".pembayaran-pr-number").text(t.pr_number),a.find(".pembayaran-item-desc").text(t.item_desc),a.find(".pembayaran-unit-price").text(g(t.unit_price)),a.find(".pembayaran-qty").text(t.quantity),a.find(".pembayaran-amount").text(g(t.amount)),t.submitted_at&&(a.find(".pembayaran-submitted-at").val(t.submitted_at),a.find(".pembayaran-submitted-date").text(Z(t.submitted_at)));const s=e("#payment_date").val();if(s&&t.submitted_at){const i=A(t.submitted_at,s);a.find(".pembayaran-sla-display").text(i+" hari"),a.find(".pembayaran-sla-input").val(i)}}function Z(t){if(!t)return"-";const n=new Date(t),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],c=n.getDate(),o=a[n.getMonth()],s=n.getFullYear().toString().substr(-2);return`${c}-${o}-${s}`}function $(){e("#pembayaran-items-container tr.pembayaran-item-row").each(function(t){e(this).find(".pembayaran-item-number").text(t+1),e(this).find("input, select, textarea").each(function(){const n=e(this).attr("name");if(!n)return;const a=n.replace(/items\[\d+\]/,`items[${t}]`);e(this).attr("name",a)})})}function L(){if(e("#pembayaran-items-container tr").not(".text-center.text-gray-500").length===0){const n=`
            <tr class="text-center text-gray-500">
                <td colspan="12" class="border px-4 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="mgc_inbox_line text-4xl text-gray-400"></i>
                        <p class="text-sm">Belum ada invoice yang dipilih</p>
                        <p class="text-xs text-gray-400">Klik tombol "Pilih Invoice" untuk memulai</p>
                    </div>
                </td>
            </tr>
        `;e("#pembayaran-items-container").html(n)}}function ee(){const t=document.getElementById("payment_date");t&&M(t,{altInput:!0,altFormat:"d-M-y",dateFormat:"Y-m-d",allowInput:!0,locale:{firstDayOfWeek:1},onChange:function(n,a){te()}})}function te(){const t=e("#payment_date").val();if(!t){e(".pembayaran-sla-display").text("-"),e(".pembayaran-sla-input").val("");return}e("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const n=e(this),a=n.find(".pembayaran-submitted-at").val();if(a){const c=A(a,t);n.find(".pembayaran-sla-display").text(c+" hari"),n.find(".pembayaran-sla-input").val(c)}else n.find(".pembayaran-sla-display").text("-"),n.find(".pembayaran-sla-input").val("")})}function ne(){e("#form-create-pembayaran").off("submit").on("submit",async function(t){if(t.preventDefault(),D)return console.log("Form is already being submitted..."),!1;if(!ae())return!1;D=!0;const n=new FormData(this),a=e("#payment_number").val(),c=e("#payment_date").val();e("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const p=(e(this).find(".pembayaran-invoice-id").attr("name")||"").match(/items\[(\d+)\]/),b=p?p[1]:null;b!==null&&(a&&n.set(`items[${b}][payment_number]`,a),n.set(`items[${b}][payment_date]`,c))});const o=e(this).find('button[type="submit"]'),s=o.html();o.prop("disabled",!0).html('<i class="mgc_loading_line animate-spin me-2"></i>Menyimpan...');try{const i=await fetch(this.action,{method:"POST",body:n,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}),h=await i.json();if(!i.ok)throw new Error(h.message||"Gagal menyimpan pembayaran");S(h.message||"Pembayaran berhasil disimpan"),setTimeout(()=>{window.location.href="/invoice/pembayaran"},1e3)}catch(i){f(i.message),o.prop("disabled",!1).html(s),D=!1}})}function ae(){if(e("#pembayaran-items-container tr.pembayaran-item-row").length===0)return f("Belum ada invoice yang dipilih. Silakan pilih minimal 1 invoice."),!1;const n=e("#payment_date").val();return!n||n.trim()===""?(f("Payment Date wajib diisi"),e("#payment_date").focus(),!1):!0}e(document).ready(function(){T()});
