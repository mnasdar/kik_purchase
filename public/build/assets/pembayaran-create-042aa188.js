import{$ as e}from"./jquery-2823516c.js";import{f as C}from"./index-a4e39586.js";import{d as p,c as N,b as w}from"./notification-0e55581f.js";import"./_commonjsHelpers-725317a4.js";import"./pembayaran-edit-5f085df9.js";let P=0,l=[],d=[];function f(t){if(t==null||t==="")return"-";const n=Number(t)||0;return new Intl.NumberFormat("id-ID").format(n)}function D(t,n){if(!t||!n)return 0;const a=new Date(t),i=new Date(n);if(a.setHours(0,0,0,0),i.setHours(0,0,0,0),i<a)return 0;let o=0;const c=new Date(a);for(;c<=i;){const s=c.getDay();s!==0&&s!==6&&o++,c.setDate(c.getDate()+1)}return o}function L(){e("#form-create-pembayaran").length&&(S(),R(),O())}function S(){e(document).on("click",".pembayaran-btn-remove-item",function(){const t=e(this).closest("tr");t.find(".pembayaran-invoice-id").val();const n=t.attr("data-row-id"),a=d.findIndex(i=>i.rowId===n);a!==-1&&(d[a].instance&&d[a].instance.destroy(),d.splice(a,1)),t.remove(),k(),$(),l.length>0&&y(l)}),A(),e(document).on("click","#btn-delete-selected-items",function(){M()}),G()}function A(){e(document).off("change","#item-select-all").on("change","#item-select-all",function(){e(".item-checkbox").prop("checked",this.checked),b()}),e(document).off("change",".item-checkbox").on("change",".item-checkbox",function(){const t=e(".item-checkbox").length===e(".item-checkbox:checked").length;e("#item-select-all").prop("checked",t),b()})}function b(){const t=e(".item-checkbox:checked").length,n=e("#btn-delete-selected-items");t>0?(n.removeClass("hidden"),e("#selected-items-count").text(t)):n.addClass("hidden")}async function M(){const t=e(".item-checkbox:checked").closest("tr"),n=t.length;if(n===0){p("Tidak ada item yang dipilih");return}await N(`Apakah Anda yakin ingin menghapus ${n} item terpilih?`,"Konfirmasi Hapus")&&(t.each(function(){const i=e(this).attr("data-row-id"),o=d.findIndex(c=>c.rowId===i);o!==-1&&(d[o].instance&&d[o].instance.destroy(),d.splice(o,1))}),t.remove(),k(),e("#item-select-all").prop("checked",!1),b(),$(),l.length>0&&y(l),w(`${n} item berhasil dihapus`))}function R(){e(document).off("click","#btn-pick-invoice").on("click","#btn-pick-invoice",async function(){await T(),E()}),e(document).off("click","#btn-close-invoice-modal").on("click","#btn-close-invoice-modal",function(){_()}),e(document).off("click",".btn-select-invoice").on("click",".btn-select-invoice",function(t){t.preventDefault(),t.stopPropagation();const n=e(this);if(n.prop("disabled"))return;n.prop("disabled",!0);const a=n.data("invoice-id"),i=l.find(o=>o.id==a);i&&(j(i),_()),setTimeout(()=>n.prop("disabled",!1),500)})}let g=[],r=1,u=10,m=[];async function T(){try{const t=await fetch("/invoice/pembayaran/get-invoices",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}});if(!t.ok)throw new Error("Gagal memuat data invoice");const n=await t.json();l=n,y(n)}catch(t){console.error("Error loading invoices:",t),p("Gagal memuat data invoice")}}function y(t){g=t;const n=[];if(e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const a=e(this).val(),i=Number(a);!Number.isNaN(i)&&i>0&&n.push(i)}),m=t.filter(a=>!n.includes(a.id)),r=1,e("#invoice-total").text(m.length),!m.length){e("#invoice-list-body").html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang tersedia atau semua sudah ditambahkan
                </td>
            </tr>
        `);return}h(r),q(),B()}function h(t){const n=(t-1)*u,a=n+u,i=m.slice(n,a),o=e("#invoice-list-body");if(o.empty(),!i.length){o.html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang cocok dengan pencarian
                </td>
            </tr>
        `);return}i.forEach(c=>{const s=`
            <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/30">
                <td class="px-3 py-2 text-left">
                    <span class="font-medium text-blue-600 dark:text-blue-400">${c.invoice_number}</span>
                </td>
                <td class="px-3 py-2 text-left">${c.po_number}</td>
                <td class="px-3 py-2 text-left">${c.pr_number}</td>
                <td class="px-3 py-2 text-left text-xs">${c.item_desc}</td>
                <td class="px-3 py-2 text-right">${f(c.unit_price)}</td>
                <td class="px-3 py-2 text-center">${c.quantity??"-"}</td>
                <td class="px-3 py-2 text-right font-semibold">${f(c.amount)}</td>
                <td class="px-3 py-2 text-center">
                    <button type="button" class="btn-select-invoice btn btn-sm bg-primary text-white hover:bg-primary-600"
                        data-invoice-id="${c.id}">
                        <i class="mgc_check_line me-1"></i>Pilih
                    </button>
                </td>
            </tr>
        `;o.append(s)}),e("#invoice-count").text(i.length),F()}function F(){const t=Math.ceil(m.length/u)||1;e("#invoice-current-page").text(r),e("#invoice-total-pages").text(t),e("#invoice-per-page").text(u),e("#btn-invoice-prev").prop("disabled",r<=1),e("#btn-invoice-next").prop("disabled",r>=t)}function q(){e(document).off("input","#invoice-search-input").on("input","#invoice-search-input",function(){const t=e(this).val().toLowerCase().trim(),n=[];e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const a=e(this).val(),i=Number(a);!Number.isNaN(i)&&i>0&&n.push(i)}),t===""?m=g.filter(a=>!n.includes(Number(a.id))):m=g.filter(a=>n.includes(Number(a.id))?!1:(a.invoice_number||"").toLowerCase().includes(t)||(a.po_number||"").toLowerCase().includes(t)||(a.pr_number||"").toLowerCase().includes(t)||(a.item_desc||"").toLowerCase().includes(t)),r=1,e("#invoice-total").text(m.length),h(r)})}function B(){e(document).off("click","#btn-invoice-prev").on("click","#btn-invoice-prev",function(){r>1&&(r--,h(r))}),e(document).off("click","#btn-invoice-next").on("click","#btn-invoice-next",function(){const t=Math.ceil(m.length/u);r<t&&(r++,h(r))})}function E(){e("#modal-pick-invoice").removeClass("hidden")}function _(){e("#modal-pick-invoice").addClass("hidden")}function j(t){e("#pembayaran-items-container tr.text-center.text-gray-500").remove();const n=[];if(e("#pembayaran-items-container tr.pembayaran-item-row .pembayaran-invoice-id").each(function(){const a=e(this).val(),i=Number(a);!Number.isNaN(i)&&i>0&&n.push(i)}),n.includes(Number(t.id))){p("Invoice ini sudah ditambahkan");return}H(t),y(l),k(),e("#item-select-all").prop("checked",!1),b(),w(`Invoice ${t.invoice_number} berhasil ditambahkan`)}function H(t){const n=e("#pembayaran-item-row-template").html(),a=e(n),i=P++,o="row-"+i;a.attr("data-row-id",o),a.find("input, select").each(function(){const s=e(this).attr("name");s&&e(this).attr("name",s.replace("[0]",`[${i}]`))}),e("#pembayaran-items-container").append(a),a.find(".pembayaran-invoice-id").val(t.id),a.find(".pembayaran-invoice-number").text(t.invoice_number),a.find(".pembayaran-po-number").text(t.po_number),a.find(".pembayaran-pr-number").text(t.pr_number),a.find(".pembayaran-item-desc").text(t.item_desc),a.find(".pembayaran-unit-price").text(f(t.unit_price)),a.find(".pembayaran-qty").text(t.quantity),a.find(".pembayaran-amount").text(f(t.amount)),t.submitted_at&&(a.find(".pembayaran-submitted-at").val(t.submitted_at),a.find(".pembayaran-submitted-date").text(W(t.submitted_at)));const c=e("#payment_date").val();if(c&&t.submitted_at){const s=D(t.submitted_at,c);a.find(".pembayaran-sla-display").text(s+" hari"),a.find(".pembayaran-sla-input").val(s)}}function W(t){if(!t)return"-";const n=new Date(t),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],i=n.getDate(),o=a[n.getMonth()],c=n.getFullYear().toString().substr(-2);return`${i}-${o}-${c}`}function k(){e("#pembayaran-items-container tr.pembayaran-item-row").each(function(t){e(this).find(".pembayaran-item-number").text(t+1),e(this).find("input, select, textarea").each(function(){const n=e(this).attr("name");if(!n)return;const a=n.replace(/items\[\d+\]/,`items[${t}]`);e(this).attr("name",a)})})}function $(){if(e("#pembayaran-items-container tr").not(".text-center.text-gray-500").length===0){const n=`
            <tr class="text-center text-gray-500">
                <td colspan="12" class="border px-4 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="mgc_inbox_line text-4xl text-gray-400"></i>
                        <p class="text-sm">Belum ada invoice yang dipilih</p>
                        <p class="text-xs text-gray-400">Klik tombol "Pilih Invoice" untuk memulai</p>
                    </div>
                </td>
            </tr>
        `;e("#pembayaran-items-container").html(n)}}function O(){const t=document.getElementById("payment_date");t&&C(t,{altInput:!0,altFormat:"d-M-y",dateFormat:"Y-m-d",allowInput:!0,locale:{firstDayOfWeek:1},onChange:function(n,a){X()}})}function X(){const t=e("#payment_date").val();if(!t){e(".pembayaran-sla-display").text("-"),e(".pembayaran-sla-input").val("");return}e("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const n=e(this),a=n.find(".pembayaran-submitted-at").val();if(a){const i=D(a,t);n.find(".pembayaran-sla-display").text(i+" hari"),n.find(".pembayaran-sla-input").val(i)}else n.find(".pembayaran-sla-display").text("-"),n.find(".pembayaran-sla-input").val("")})}function G(){e("#form-create-pembayaran").on("submit",async function(t){if(t.preventDefault(),!J())return;const n=new FormData(this),a=e("#payment_number").val(),i=e("#payment_date").val();e("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const I=(e(this).find(".pembayaran-invoice-id").attr("name")||"").match(/items\[(\d+)\]/),v=I?I[1]:null;v!==null&&(a&&n.set(`items[${v}][payment_number]`,a),n.set(`items[${v}][payment_date]`,i))});const o=e(this).find('button[type="submit"]'),c=o.html();o.prop("disabled",!0).html('<i class="mgc_loading_line animate-spin me-2"></i>Menyimpan...');try{const s=await fetch(this.action,{method:"POST",body:n,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}),x=await s.json();if(!s.ok)throw new Error(x.message||"Gagal menyimpan pembayaran");w(x.message||"Pembayaran berhasil disimpan"),setTimeout(()=>{window.location.href="/invoice/pembayaran"},1e3)}catch(s){p(s.message),o.prop("disabled",!1).html(c)}})}function J(){if(e("#pembayaran-items-container tr.pembayaran-item-row").length===0)return p("Belum ada invoice yang dipilih. Silakan pilih minimal 1 invoice."),!1;const n=e("#payment_date").val();return!n||n.trim()===""?(p("Payment Date wajib diisi"),e("#payment_date").focus(),!1):!0}e(document).ready(function(){L()});
