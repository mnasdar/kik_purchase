import{$ as e}from"./modal-handler-2823516c.js";import{s as k}from"./index-88056f3d.js";import{b as i,a as P}from"./gridjs.module-3ea5c5ab.js";import{t as L}from"./tippy.all-093076db.js";import{s as l,a as A}from"./notification-d92c8c7c.js";import"./_commonjsHelpers-725317a4.js";import"./parse-c3570fb2.js";import"./notification-5f085df9.js";let h=null,y=null,g=null,d={};function D(){return[{id:"checkbox",name:i("div",{innerHTML:'<input type="checkbox" id="headerCheck" class="form-checkbox rounded text-primary">'}),width:"50px",sort:!1,formatter:t=>i("div",{innerHTML:t})},{id:"number",name:"#",width:"60px"},{id:"request_type",name:"Type",width:"70px",formatter:t=>i("div",{innerHTML:t})},{id:"pr_number",name:"PR Number",width:"180px",formatter:t=>i("div",{innerHTML:t})},{id:"location",name:"Location",width:"150px",formatter:t=>i("div",{innerHTML:t})},{id:"items_count",name:"Items",width:"100px",formatter:t=>i("div",{innerHTML:t})},{id:"total_amount",name:"Total Amount",width:"150px",formatter:t=>i("div",{innerHTML:t})},{id:"approved_date",name:"Approved Date",width:"150px",formatter:t=>i("div",{innerHTML:t})},{id:"created_by",name:"Created By",width:"150px",formatter:t=>i("div",{innerHTML:t})},{id:"actions",name:"Actions",width:"100px",sort:!1,formatter:t=>i("div",{innerHTML:t})}]}function f(t=!1){e.ajax({url:k("purchase-request.data",{prefix:y}),method:"GET",data:d,dataType:"json",beforeSend:function(){t&&l("Memuat data...","info",1e3)},success:function(a){if(!Array.isArray(a)){console.error("Invalid response format. Expected array, got:",typeof a),l("Format data tidak valid","error",2e3);return}const o=a.map(r=>[r.checkbox,r.number,r.request_type,r.pr_number,r.location,r.items_count,r.total_amount,r.approved_date,r.created_by,r.actions]);h?h.updateConfig({data:o}).forceRender():(h=new P({columns:D(),data:o,pagination:{limit:10},search:!0,sort:!0}),h.render(document.querySelector("#table-pr"))),e("#data-count").text(a.length),setTimeout(()=>{L("[data-plugin='tippy']",{arrow:!0,animation:"scale"}),S()},300),t&&l("Data berhasil direfresh","success",1500)},error:function(a,o,r){let s="Gagal memuat data",c="";try{if(a.responseJSON&&a.responseJSON.message)s=a.responseJSON.message,c=a.responseJSON.error||"";else if(a.responseText){const u=JSON.parse(a.responseText);s=u.message||s,c=u.error||""}}catch{c=a.responseText||r}console.error("Error loading PR data:",{status:a.status,statusText:a.statusText,error:r,message:s,details:c,response:a.responseText}),t&&l(s,"error",2e3)}})}function E(){y=e("[data-prefix]").data("prefix"),e("#table-pr").length&&f(!1)}function S(){e(document).on("change","#headerCheck",function(){const t=e(this).prop("checked");e(".form-checkbox").not("#headerCheck").not(":disabled").prop("checked",t),T()}),e(document).on("change",".form-checkbox",function(){if(!e(this).is("#headerCheck")){T();const t=e(".form-checkbox").not("#headerCheck").not(":disabled").length,a=e(".form-checkbox:checked").not("#headerCheck").not(":disabled").length;e("#headerCheck").prop("checked",t===a&&t>0)}})}function T(){const t=e(".form-checkbox:checked").not("#headerCheck").not(":disabled").length,a=e("#btn-delete-selected");t>1?a.removeClass("hidden").prop("disabled",!1):a.addClass("hidden").prop("disabled",!0)}function I(){e(document).on("click",".btn-edit-pr",function(){const t=e(this).data("id"),a=k("purchase-request.edit",{purchase_request:t});window.location.href=a})}function B(){e("#btn-refresh").on("click",function(){f(!0)})}function $(){e("#btn-toggle-filter").on("click",function(){e("#filter-section").toggleClass("hidden")}),e("#btn-apply-filter").on("click",function(){d={pr_number:e("#filter-pr-number").val(),item_desc:e("#filter-item-desc").val(),request_type:e("#filter-request-type").val(),location_id:e("#filter-location").val(),current_stage:e("#filter-stage").val(),classification_id:e("#filter-classification").val(),date_from:e("#filter-date-from").val(),date_to:e("#filter-date-to").val()},Object.keys(d).forEach(t=>{d[t]||delete d[t]}),f(!0)}),e("#btn-clear-filter").on("click",function(){e("#filter-pr-number").val(""),e("#filter-item-desc").val(""),e("#filter-request-type").val(""),e("#filter-location").val(""),e("#filter-stage").val(""),e("#filter-classification").val(""),e("#filter-date-from").val(""),e("#filter-date-to").val("");const t=d.stat_filter;d={},t&&(d.stat_filter=t),f(!0)}),d={stat_filter:"items_without_po"},e(document).on("click",".stat-card",function(){const t=e(this).data("stat-filter");e(".stat-card").removeClass("active").removeClass("ring-4").removeClass("ring-white/30"),e(this).addClass("active").addClass("ring-4").addClass("ring-white/30"),e("#filter-pr-number").val(""),e("#filter-item-desc").val(""),e("#filter-request-type").val(""),e("#filter-location").val(""),e("#filter-stage").val(""),e("#filter-classification").val(""),e("#filter-date-from").val(""),e("#filter-date-to").val(""),d={stat_filter:t},f(!0)})}function O(){e(document).on("click","#detailPRModalClose, #detailPRModalBackdrop",function(){x()}),e(document).on("keydown",function(t){t.key==="Escape"&&x()}),e(document).on("click",".pr-items-count",function(t){t.preventDefault();const a=e(this).data("pr-id");a&&N(a)})}function N(t){const a=e("#detailPRModal"),o=e("#detailPRModalBackdrop"),r=e("#detailPRModalContent");a.removeClass("hidden"),a.css("opacity","1"),setTimeout(()=>{o.css("opacity","1"),r.css({transform:"scale(1)",opacity:"1"})},10),e.ajax({url:k("purchase-request.detail",{prefix:y,purchase_request:t}),method:"GET",success:function(s){G(s)},error:function(s){console.error("Error loading PR detail:",s),l("Gagal memuat detail PR","error",2e3),x()}})}function x(){const t=e("#detailPRModal"),a=e("#detailPRModalBackdrop"),o=e("#detailPRModalContent");a.css("opacity","0"),o.css({transform:"scale(0.95)",opacity:"0"}),t.css("opacity","0"),setTimeout(()=>{t.addClass("hidden")},300)}function G(t){const{pr:a,items:o}=t;e("#detailPRNumber").text(a.pr_number),e("#detailPRApprovedDate").text(a.approved_date),e("#detailPRLocation").text(a.location),e("#detailPRCreatedBy").text(a.created_by),e("#detailPRCreatedAt").text(a.created_at);const r=a.request_type?`<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold ${a.request_type==="barang"?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400":"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400"}">${a.request_type.charAt(0).toUpperCase()+a.request_type.slice(1)}</span>`:"-";e("#detailPRRequestType").html(r);const s=a.status?a.status:"-";e("#detailPRStatus").html(s),e("#detailPRNotes").text(a.notes);const c=Array.isArray(o)?o.length:0;e("#detailPRHeaderItems").html(`<i class="mgc_shopping_bag_3_line"></i> ${c} Items`);const u=n=>{if(n==null)return 0;const M=String(n).replace(/[^\d]/g,"");return M?parseInt(M,10):0},w=(o||[]).reduce((n,m)=>n+u(m.amount),0),q=n=>n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".");e("#detailPRHeaderTotal").html(`<i class="mgc_wallet_3_line"></i> Total Rp ${q(w)}`);const H=document.querySelector("#detailPRItemsGrid"),v=o.map((n,m)=>[m+1,`<span class="detail-item-desc cursor-pointer text-blue-600">${n.item_desc}</span>`,n.classification?`<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200">${n.classification}</span>`:"-",n.uom,n.quantity,`Rp ${n.unit_price}`,`Rp ${n.amount}`,n.current_stage_badge||"-",n.sla_pr_to_po_target??"-"]),_=[{id:"number",name:"#",width:"60px"},{id:"item_desc",name:"Item Description",width:"250px",formatter:n=>i("div",{innerHTML:n})},{id:"classification",name:"Classification",width:"200px",formatter:n=>i("div",{innerHTML:n})},{id:"uom",name:"UOM",width:"100px"},{id:"quantity",name:"Quantity",width:"110px",formatter:n=>i("div",{innerHTML:n})},{id:"unit_price",name:"Unit Price",width:"140px",formatter:n=>i("div",{innerHTML:n})},{id:"amount",name:"Amount",width:"140px",formatter:n=>i("div",{innerHTML:n})},{id:"current_stage",name:"Status",width:"150px",formatter:n=>i("div",{innerHTML:n})},{id:"sla_pr_to_po_target",name:i("div",{className:"whitespace-normal",innerHTML:"Target SLA PRâ†’PO"}),width:"180px",formatter:n=>i("div",{innerHTML:n})}];g?g.updateConfig({data:v,columns:_,pagination:{limit:10},search:!0}).forceRender():(g=new P({columns:_,data:v,pagination:{limit:10},search:!0}),g.render(H))}let p=[],C=null;function R(){const t=e("#deleteModal"),a=e("#deleteModalBackdrop"),o=e("#deleteModalContent");t.removeClass("hidden").css("opacity","1"),requestAnimationFrame(()=>{a.css("opacity","1"),o.css({transform:"scale(1)",opacity:"1"})})}function b(){const t=e("#deleteModalBackdrop"),a=e("#deleteModalContent");t.css("opacity","0"),a.css({transform:"scale(0.95)",opacity:"0"}),setTimeout(()=>{e("#deleteModal").addClass("hidden").css("opacity","0"),p=[]},300)}function F(){C=e("[data-prefix]").data("prefix"),e(document).on("click",".btn-delete-pr",function(){const t=e(this).data("id"),a=e(this).data("number");p=[t],e("#deleteMessage").text(`Apakah Anda yakin ingin menghapus PR "${a}"?`),R()}),e("#btn-delete-selected").on("click",function(){const t=e(".form-checkbox:checked").not("#headerCheck");if(t.length===0){l("Pilih minimal 1 PR untuk dihapus","warning",2e3);return}p=t.map(function(){return e(this).val()}).get(),e("#deleteMessage").text(`Apakah Anda yakin ingin menghapus ${p.length} purchase request?`),R()}),e("#deleteModalConfirm").on("click",async function(){var o;const t=e(this),a=t.text();t.prop("disabled",!0).text("Menghapus...");try{await e.ajax({url:k("purchase-request.bulkDestroy",{prefix:C}),method:"DELETE",data:{ids:p},headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")}}),b(),l("Purchase request berhasil dihapus!","success",2e3),setTimeout(()=>location.reload(),500)}catch(r){A(((o=r.responseJSON)==null?void 0:o.message)||"Gagal menghapus purchase request","Gagal!")}finally{t.prop("disabled",!1).text(a)}}),e("#deleteModalCancel").on("click",b),e("#deleteModal").on("click",function(t){e(t.target).is("#deleteModal")&&b()}),e(document).on("keydown",function(t){t.key==="Escape"&&(e("#deleteModal").hasClass("hidden")||b())})}e(document).ready(function(){E(),B(),I(),O(),$(),F()});
