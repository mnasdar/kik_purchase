import{s as f,c as g}from"./notification-0e55581f.js";import{s as b}from"./index-88056f3d.js";import{$ as t}from"./jquery-2823516c.js";import{A as y}from"./AutoNumericPredefinedOptions-22c6ad49.js";import{f as D}from"./index-a4e39586.js";import"./pembayaran-edit-5f085df9.js";import"./_commonjsHelpers-725317a4.js";import"./parse-c3570fb2.js";let $=0,m={};function N(){if(document.querySelector("style[data-po-create]"))return;const e=`
input[type="number"].po-item-quantity{padding-right:0 !important;}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{
    -webkit-appearance:none;
    margin:0;
    padding:0;
    width:40px;
    height:100%;
    background:#f3f4f6;
    border-left:1px solid #e5e7eb;
    cursor:pointer;
}
input[type="number"]::-webkit-outer-spin-button{border-bottom:1px solid #e5e7eb;}
input[type="number"]::-webkit-inner-spin-button{border-top:1px solid #e5e7eb;}
input[type="number"]{-moz-appearance:textfield;}
`,n=document.createElement("style");n.setAttribute("data-po-create","true"),n.textContent=e,document.head.appendChild(n)}function T(){t("#form-create-pr").length&&(F(),q(),x(),M(),N(),v())}function q(){t("#btn-add-item").on("click",function(){v()}),t(document).on("click",".btn-remove-item",function(){const e=t(this).closest("tr");if(t("#items-container tr").length<=1){f("Minimal harus ada 1 item","warning",2e3);return}e.remove(),C(),S()}),t(document).on("input",".item-quantity",function(){const e=t(this).closest("tr");w(e)}),t(document).on("blur",".item-quantity",async function(){const e=t(this).closest("tr"),n=parseFloat(t(this).val());n&&n>0&&await V(e)}),t(document).on("input change",".classification-input",function(){const e=t(this),s=e.closest("tr").find(".classification-id"),i=e.val().trim();if(!i){s.val(""),e.removeClass("border-green-500 border-amber-500");return}const u=e.attr("list"),c=t(`#${u}`);let o="";c.find("option").each(function(){const a=t(this).val(),r=t(this).attr("data-id");if(a.toLowerCase()===i.toLowerCase())return o=r,!1}),o?(s.val(o),e.removeClass("border-amber-500").addClass("border-green-500")):(s.val(""),e.removeClass("border-green-500").addClass("border-amber-500"))}),t(document).on("blur",".classification-input",function(){const e=t(this),s=e.closest("tr").find(".classification-id"),i=e.val().trim();if(!i){s.val(""),e.removeClass("border-green-500 border-amber-500");return}const u=e.attr("list"),c=t(`#${u}`);let o="";c.find("option").each(function(){const a=t(this).val(),r=t(this).attr("data-id");if(a.toLowerCase()===i.toLowerCase())return o=r,!1}),o?(s.val(o),e.removeClass("border-amber-500").addClass("border-green-500")):(s.val(""),e.removeClass("border-green-500").addClass("border-amber-500"))})}function x(){D("#approved_date",{altInput:!0,altFormat:"d-M-y",dateFormat:"Y-m-d",allowInput:!0,locale:{firstDayOfWeek:1}})}function v(){const e=t("#item-row-template").html(),n=t(e),s=$++;n.find("select, input").each(function(){const r=t(this).attr("name");r&&t(this).attr("name",r.replace("[0]",`[${s}]`))});const i=n.find(".classification-input"),u=`classification-list-${s}`;i.attr("list",u),n.find("datalist").attr("id",u),t("#items-container").append(n);const c=n.index(),o=n.find('input[name*="unit_price"]')[0],a=n.find('input[name*="amount"]')[0];o&&(m[`unit_price_${c}`]=new y(o,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),t(o).on("change",function(){w(n)})),a&&(m[`amount_${c}`]=new y(a,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"})),S()}function C(){Object.keys(m).forEach(e=>{m[e]&&(m[e].remove(),delete m[e])}),t("#items-container tr").each(function(e){const n=t(this),s=n.find('input[name*="unit_price"]')[0],i=n.find('input[name*="amount"]')[0];s&&!m[`unit_price_${e}`]&&(m[`unit_price_${e}`]=new y(s,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),t(s).on("change",function(){w(n)})),i&&!m[`amount_${e}`]&&(m[`amount_${e}`]=new y(i,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}))})}function S(){t("#items-container tr").each(function(e){t(this).find(".item-number").text(e+1),t(this).find("select, input").each(function(){const n=t(this).attr("name");n&&t(this).attr("name",n.replace(/\[\d+\]/,`[${e}]`))})})}function O(e){Object.keys(e).forEach(n=>{const s=t(`#error-${n}`);s.length&&s.text(e[n][0]).removeClass("hidden")})}function R(e){t(`#error-${e}`).text("").addClass("hidden")}function E(){t('[id^="error-"]').text("").addClass("hidden")}function w(e){const n=e.index(),s=parseFloat(e.find(".item-quantity").val())||0,i=m[`unit_price_${n}`],u=m[`amount_${n}`];if(!i||!u)return;const c=i.getNumber()||0,o=s*c;u.set(o)}function F(){t("#form-create-pr").on("submit",async function(e){var c,o;e.preventDefault(),E();const n=A();if(!n.isValid){f(n.message,"error",3e3);return}if(!await g("Data purchase request akan disimpan ke sistem.","Konfirmasi Simpan"))return;const i=t(this).find('button[type="submit"]'),u=i.html();i.prop("disabled",!0).html('<i class="mgc_loading_line animate-spin me-2"></i>Menyimpan...');try{Object.values(m).forEach(l=>{const p=l.getNumber(),h=l.domElement||l.input||l.element;h&&(h.value=p)});const a=new FormData(this),r=[];t("#items-container tr").each(function(){const l=t(this).attr("data-restore-item-id");l&&r.push(l)}),r.length>0&&a.append("restore_item_ids",JSON.stringify(r));const d=await t.ajax({url:t(this).attr("action"),method:"POST",data:a,processData:!1,contentType:!1,headers:{"X-CSRF-TOKEN":t('meta[name="csrf-token"]').attr("content")}});f("Purchase request berhasil ditambahkan!","success",2e3),setTimeout(()=>{window.location.href=b("purchase-request.index")},500)}catch(a){if(console.error("Error:",a),a.status===422&&((c=a.responseJSON)!=null&&c.errors))O(a.responseJSON.errors),f("Periksa kembali form Anda","error",3e3);else{const r=((o=a.responseJSON)==null?void 0:o.message)||"Terjadi kesalahan saat menyimpan data";f(r,"error",3e3)}i.prop("disabled",!1).html(u)}})}function A(){const e=t("#pr_number").val().trim(),n=t("#approved_date").val().trim(),s=t("#request_type").val().trim(),i=t("#location_id").val(),u=t("#items-container tr").length;if(!e)return{isValid:!1,message:"PR Number harus diisi"};if(!n)return{isValid:!1,message:"Approved Date harus diisi"};if(!s)return{isValid:!1,message:"Request Type harus diisi"};if(!i)return{isValid:!1,message:"Location harus diisi"};if(u===0)return{isValid:!1,message:"Minimal harus ada 1 item"};let c=!0,o="";const a=[];if(t("#items-container tr").each(function(r){t(this).find('select[name*="classification_id"]').val();const d=t(this).find('input[name*="item_desc"]').val().trim(),l=t(this).find('input[name*="uom"]').val().trim(),p=parseFloat(t(this).find('input[name*="quantity"]').val())||0,h=t(this).index(),k=m[`unit_price_${h}`],I=k?k.getNumber():0;if(!d)return c=!1,o=`Item #${r+1}: Item Description harus diisi`,!1;if(!l)return c=!1,o=`Item #${r+1}: UOM harus diisi`,!1;if(I<=0)return c=!1,o=`Item #${r+1}: Unit Price harus lebih dari 0`,!1;if(p<=0)return c=!1,o=`Item #${r+1}: Quantity harus lebih dari 0`,!1;const _=t(this).find('input[name*="sla_pr_to_po_target"]').val(),P=_!=null&&_!==""?parseInt(_,10):NaN;if(Number.isNaN(P)||P<0)return c=!1,o=`Item #${r+1}: SLA PRâ†’PO Target (hari) wajib diisi dan >= 0`,!1;a.push({index:r+1,itemDesc:d.toLowerCase(),uom:l.toLowerCase(),unitPrice:I})}),c){for(let r=0;r<a.length;r++)for(let d=r+1;d<a.length;d++)if(a[r].itemDesc===a[d].itemDesc&&a[r].uom===a[d].uom&&a[r].unitPrice===a[d].unitPrice)return c=!1,o=`Item #${a[r].index} dan #${a[d].index} memiliki Item Description, UOM, dan Unit Price yang sama (duplikat)`,{isValid:!1,message:o}}return c?{isValid:!0}:{isValid:!1,message:o}}async function V(e){const n=e.find('input[name*="item_desc"]').val().trim(),s=e.find('input[name*="uom"]').val().trim(),i=e.index(),u=m[`unit_price_${i}`],c=u?u.getNumber():0,o=t("#pr_number").val().trim();if(!(!n||!s||!c||c<=0||!o))try{const a=await t.ajax({url:b("purchase-request.checkDeletedItem"),method:"POST",data:{pr_number:o,item_desc:n,uom:s,unit_price:c},headers:{"X-CSRF-TOKEN":t('meta[name="csrf-token"]').attr("content")}});if(a.has_deleted_item&&a.deleted_item){const r=a.deleted_item;if(await g(`Data item "${r.item_desc}" dengan UOM "${r.uom}" dan Unit Price ${new Intl.NumberFormat("id-ID").format(r.unit_price)} pernah diinput sebelumnya.

Apakah Anda ingin mengaktifkan kembali data tersebut?`,"Item Pernah Diinput",{confirmButtonText:"Ya, Aktifkan Kembali",cancelButtonText:"Tidak, Input Manual",showCancelButton:!0})){r.classification_id&&e.find('select[name*="classification_id"]').val(r.classification_id);const l=e.find('input[name*="quantity"]'),p=m[`amount_${i}`];l.val(r.quantity),p&&p.set(r.amount),e.attr("data-restore-item-id",r.id),e.addClass("restore-item"),f("Data berhasil diisi dari riwayat sebelumnya","success",2e3)}}}catch(a){console.error("Error checking deleted item:",a)}}function j(){t("#pr_number").on("input",function(){R("pr_number")})}function M(){let e=null;t("#pr_number").on("input blur",function(){const n=t(this).val().trim();e&&clearTimeout(e),n&&(e=setTimeout(async()=>{await L(n)},800))})}async function L(e){try{const n=await t.ajax({url:b("purchase-request.checkDeletedPR"),method:"POST",data:{pr_number:e},headers:{"X-CSRF-TOKEN":t('meta[name="csrf-token"]').attr("content")}});if(n.has_deleted_pr&&n.deleted_pr){const s=n.deleted_pr;await g(`PR Number "${s.pr_number}" pernah diinput sebelumnya dengan ${s.items.length} item(s), namun telah dihapus.

Apakah Anda ingin mengaktifkan kembali data tersebut?

Jika ya, semua data PR dan items akan otomatis terisi.`,"PR Pernah Diinput",{confirmButtonText:"Ya, Aktifkan Kembali",cancelButtonText:"Tidak, Input Manual",showCancelButton:!0})&&await K(s)}}catch(n){console.error("Error checking deleted PR:",n)}}async function K(e){var n;try{const s=await t.ajax({url:b("purchase-request.restore",{id:e.id}),method:"POST",headers:{"X-CSRF-TOKEN":t('meta[name="csrf-token"]').attr("content")}});if(t("#pr_number").val(e.pr_number),t("#request_type").val(e.request_type),t("#notes").val(e.notes||""),e.approved_date){t("#approved_date").val(e.approved_date);const i=t("#approved_date")[0]._flatpickr;i&&i.setDate(e.approved_date,!0)}e.location_id&&t("#location_id").val(e.location_id),t("#items-container").empty(),$=0,C();for(const i of e.items){v();const u=t("#items-container tr:last"),c=u.index();i.classification_id&&i.classification_name&&(u.find(".classification-input").val(i.classification_name).addClass("border-green-500"),u.find(".classification-id").val(i.classification_id)),u.find('input[name*="item_desc"]').val(i.item_desc),u.find('input[name*="uom"]').val(i.uom),u.find('input[name*="quantity"]').val(i.quantity);const o=m[`unit_price_${c}`],a=m[`amount_${c}`];o&&o.set(i.unit_price),a&&a.set(i.amount)}f("Data PR berhasil diaktifkan kembali! Silakan review dan simpan.","success",3e3),setTimeout(()=>{window.location.href=b("purchase-request.index")},1500)}catch(s){console.error("Error restoring PR:",s);const i=((n=s.responseJSON)==null?void 0:n.message)||"Gagal mengaktifkan kembali PR";f(i,"error",3e3)}}t(document).ready(function(){T(),j()});
