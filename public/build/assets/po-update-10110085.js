import{f as et}from"./index-a4e39586.js";import{A as S}from"./AutoNumericPredefinedOptions-22c6ad49.js";import{a as C,c as T,b as M,d as $}from"./notification-0e55581f.js";import{s as W}from"./index-88056f3d.js";import{$ as e}from"./jquery-2823516c.js";import{N as nt}from"./nice-select2-6e0cfbe7.js";import"./pembayaran-edit-5f085df9.js";import"./_commonjsHelpers-725317a4.js";import"./parse-c3570fb2.js";let H=-1,c={},f=[];e("[data-po-id]").data("po-id");let k={},P={},G=!1;function R(t){if(!t)return null;if(t instanceof Date&&!Number.isNaN(t))return new Date(t.getFullYear(),t.getMonth(),t.getDate());if(typeof t=="string"){const a=t.trim();if(!a)return null;const n=a.split(" ")[0].split("T")[0],[i,o,r]=n.split("-").map(l=>parseInt(l,10));if(!Number.isNaN(i)&&!Number.isNaN(o)&&!Number.isNaN(r)){const l=new Date(i,o-1,r);if(!Number.isNaN(l))return l}const s=new Date(a);if(!Number.isNaN(s))return new Date(s.getFullYear(),s.getMonth(),s.getDate())}return null}function Y(t,a=null){const n=R(t),i=R(a||new Date);if(!n||!i||n>i)return 0;let o=0,r=new Date(n);for(;r<=i;){const s=r.getDay();s>=1&&s<=5&&o++,r.setDate(r.getDate()+1)}return o}function J(){const t=e("#po-items-container tr").not(".text-center.text-gray-500");let a=0;t.each(function(){const n=parseFloat(e(this).find('input[name*="sla_pr_to_po_realization"]').val());!Number.isNaN(n)&&n<1&&a++}),a>0&&C(`Terdapat ${a} item dengan SLA Realisasi < 1 (tanggal PR lebih besar dari tanggal PO).`)}function at(t,a){const n=R(t),i=R(a);return!n||!i?!1:n>i}function it(t){return t?t.approved_date_raw||t.approved_date||t.approvedDate||t.approved_at||(Array.isArray(t.items)&&t.items.length?t.items[0].approved_date:null):null}function B(t){if(t==null||t==="")return"-";const a=Number(t)||0;return new Intl.NumberFormat("id-ID").format(a)}function E(t){if(!t)return"-";try{const a=new Date(t+"T00:00:00");return new Intl.DateTimeFormat("id-ID",{day:"2-digit",month:"short",year:"2-digit"}).format(a)}catch{return t}}e(document).ready(function(){e("#supplier_id").each(function(){new nt(this,{searchable:!0})})});function ot(){if(document.querySelector("style[data-po-update]"))return;const t=`
input[type="number"].po-item-quantity{padding-right:0 !important;}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{
    -webkit-appearance:none;
    margin:0;
    padding:0;
    width:40px;
    height:100%;
    background:#f3f4f6;
    border-left:1px solid #e5e7eb;
    cursor:pointer;
}
input[type="number"]::-webkit-outer-spin-button{border-bottom:1px solid #e5e7eb;}
input[type="number"]::-webkit-inner-spin-button{border-top:1px solid #e5e7eb;}
input[type="number"]{-moz-appearance:textfield;}
`,a=document.createElement("style");a.setAttribute("data-po-update","true"),a.textContent=t,document.head.appendChild(a)}function rt(){e("#form-create-po").length&&(ot(),st(),wt(),lt(),pt(),j(),Pt(),Ct())}function st(){et("#approved_date",{altInput:!0,altFormat:"d-M-y",dateFormat:"Y-m-d",allowInput:!0,locale:{firstDayOfWeek:1},onChange:function(t,a,n){ct(a)}})}function ct(t){!t||t.trim()===""||(e("#po-items-container .po-item-row").each(function(){const a=e(this),n=a.find(".po-pr-approved-date").attr("data-pr-approved-date");if(n&&n.trim()!==""){const i=Y(n,t);a.find('input[name*="sla_pr_to_po_realization"]').val(i)}}),J())}function lt(){e(document).on("click",".po-btn-remove-item",function(){e(this).closest("tr").remove(),j(),O(),X(),f.length>0&&N(f)}),e(document).on("input",".po-item-quantity",function(){const t=e(this).closest("tr");q(t)}),ut(),e(document).on("click","#btn-delete-selected-items",function(){dt()})}function ut(){e(document).off("change","#item-select-all").on("change","#item-select-all",function(){const t=e(this).prop("checked");e(".item-checkbox").prop("checked",t),L()}),e(document).off("change",".item-checkbox").on("change",".item-checkbox",function(){const t=e(".item-checkbox").length,a=e(".item-checkbox:checked").length;e("#item-select-all").prop("checked",t===a),L()})}function L(){const t=e(".item-checkbox:checked").length,a=e("#btn-delete-selected-items");t>0?(a.removeClass("hidden"),e("#selected-items-count").text(t)):a.addClass("hidden")}async function dt(){const t=e(".item-checkbox:checked").closest("tr"),a=t.length;if(a===0){C("Pilih minimal 1 item untuk dihapus");return}await T(`Apakah Anda yakin ingin menghapus ${a} item terpilih?`,"Konfirmasi Hapus")&&(t.remove(),j(),O(),e("#item-select-all").prop("checked",!1),L(),X(),f.length>0&&N(f),M(`${a} item berhasil dihapus`))}function pt(){e(document).on("click","#btn-pick-pr",async function(){await mt(),ht()}),e(document).on("click","#btn-close-pr-modal",function(){K()}),e(document).on("click",".btn-select-pr",function(){const t=e(this).data("pr-id"),a=f.find(n=>n.id===t);if(!a){$("PR tidak ditemukan");return}bt(a),K()})}async function mt(){try{const t=await fetch(W("purchase-order.pr-list"),{headers:{Accept:"application/json"}}),a=await t.json();if(!t.ok){$(a.message||"Gagal memuat PR");return}f=a.data||[],N(f)}catch(t){console.error(t),$("Gagal memuat PR")}}let V=[],u=1,D=10,b=[];function N(t){V=t;const a=[];if(e("#po-items-container .po-pr-item-id").each(function(){const n=e(this).val();n&&a.push(parseInt(n))}),b=t.map(n=>{const i=n.items.filter(o=>!a.includes(o.id));return{...n,available_items_count:i.length}}).filter(n=>n.available_items_count>0),u=1,e("#pr-total").text(b.length),!b.length){e("#pr-list-body").html('<tr><td colspan="5" class="px-3 py-3 text-center text-gray-500">Semua item dari PR sudah ditambahkan ke tabel</td></tr>'),e("#pr-count").text(0),Q();return}F(u),ft(),_t()}function F(t){const a=(t-1)*D,n=a+D,i=b.slice(a,n),o=e("#pr-list-body");if(o.empty(),!i.length){o.append('<tr><td colspan="5" class="px-3 py-3 text-center text-gray-500">Tidak ada PR yang sesuai</td></tr>');return}i.forEach(r=>{const s=r.available_items_count||0,l=r.location_name||"-",_=r.formatted_approved_date||"-";o.append(`
            <tr class="border-b last:border-0 pr-row" data-pr-number="${r.pr_number}" data-location="${l}">
                <td class="px-3 py-2 font-semibold text-gray-800 dark:text-gray-100">${r.pr_number}</td>
                <td class="px-3 py-2 text-gray-600 dark:text-gray-300">${l}</td>
                <td class="px-3 py-2 text-gray-600 dark:text-gray-300">${_}</td>
                <td class="px-3 py-2 text-center">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                        <i class="mgc_check_line"></i>
                        ${s} tersedia
                    </span>
                </td>
                <td class="px-3 py-2 text-center">
                    <button type="button" class="btn btn-sm bg-primary text-white hover:bg-primary-600 btn-select-pr" data-pr-id="${r.id}">
                        Pilih
                    </button>
                </td>
            </tr>
        `)}),e("#pr-count").text(i.length),Q()}function Q(){const t=Math.ceil(b.length/D)||1;e("#pr-current-page").text(u),e("#pr-total-pages").text(t),e("#pr-per-page").text(D),e("#btn-pr-prev").prop("disabled",u<=1),e("#btn-pr-next").prop("disabled",u>=t)}function ft(){e(document).off("input","#pr-search-input").on("input","#pr-search-input",function(){const t=e(this).val().toLowerCase().trim();if(t){const a=[];e("#po-items-container .po-pr-item-id").each(function(){const n=e(this).val();n&&a.push(parseInt(n))}),b=V.filter(n=>{const i=(n.pr_number||"").toLowerCase(),o=(n.location_name||"").toLowerCase();return i.includes(t)||o.includes(t)}).map(n=>{const i=n.items.filter(o=>!a.includes(o.id));return{...n,available_items_count:i.length}}).filter(n=>n.available_items_count>0)}else{const a=[];e("#po-items-container .po-pr-item-id").each(function(){const n=e(this).val();n&&a.push(parseInt(n))}),b=V.map(n=>{const i=n.items.filter(o=>!a.includes(o.id));return{...n,available_items_count:i.length}}).filter(n=>n.available_items_count>0)}u=1,e("#pr-total").text(b.length),F(u)})}function _t(){e(document).off("click","#btn-pr-prev").on("click","#btn-pr-prev",function(){u>1&&(u--,F(u),e("#pr-list-body").closest(".overflow-x-auto").scrollTop(0))}),e(document).off("click","#btn-pr-next").on("click","#btn-pr-next",function(){const t=Math.ceil(b.length/D);u<t&&(u++,F(u),e("#pr-list-body").closest(".overflow-x-auto").scrollTop(0))})}function ht(){e("#modal-pick-pr").removeClass("hidden")}function K(){e("#modal-pick-pr").addClass("hidden")}function bt(t){if(!t||!Array.isArray(t.items)){C("PR tidak memiliki item");return}const a=e("#approved_date").val().trim(),n=it(t),i=a&&n&&at(n,a);i&&C(`Tanggal Approved PR (${E(n)}) lebih besar dari tanggal Approved PO (${E(a)}).`),e("#po-items-container tr.text-center.text-gray-500").remove();const o=[];e("#po-items-container .po-pr-item-id").each(function(){const s=e(this).val();s&&o.push(parseInt(s))});let r=0;if(t.items.forEach(s=>{o.includes(s.id)||(gt({id:s.id,pr_number:t.pr_number,item_desc:s.item_desc,uom:s.uom,unit_price:s.unit_price,quantity:s.quantity,amount:s.amount,cost_saving:s.cost_saving??0,approved_date:t.approved_date_raw}),r++)}),r===0){C(`Semua item dari PR ${t.pr_number} sudah ada dalam tabel`);return}N(f),O(),e("#item-select-all").prop("checked",!1),L(),J(),i?C(`${r} item dari PR ${t.pr_number} ditambahkan, namun tanggal approved PR lebih besar dari PO.`):M(`${r} item dari PR ${t.pr_number} berhasil ditambahkan`)}function gt(t=null){const a=e("#po-item-row-template").html(),n=e(a),i=H--;n.attr("data-row-id",i),n.find("input, select").each(function(){const v=e(this).attr("name");if(v){const A=v.replace(/\[\d+\]/,`[${i}]`);e(this).attr("name",A)}}),e("#po-items-container").append(n);const o=n.attr("data-row-id"),r=n.find('input[name$="[unit_price]"]')[0],s=n.find('input[name$="[amount]"]')[0],l=n.find(".po-pr-item-id")[0],_=n.find(".po-pr-desc")[0],p=n.find(".po-pr-uom")[0],m=n.find(".po-pr-amount")[0],w=n.find(".po-pr-unit-price-display"),d=n.find(".po-pr-qty-display"),y=n.find(".po-pr-amount-display");r&&(c[`unit_price_${o}`]=new S(r,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),e(r).on("input keyup blur autoNumeric:rawValueModified",function(){q(n)}),t!=null&&t.unit_price&&c[`unit_price_${o}`].set(t.unit_price)),s&&(c[`amount_${o}`]=new S(s,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),t!=null&&t.amount&&c[`amount_${o}`].set(t.amount)),m&&(t!=null&&t.amount)&&e(m).val(t.amount),w&&(t==null?void 0:t.unit_price)!==void 0&&w.text(B(t.unit_price)),d&&(t==null?void 0:t.quantity)!==void 0&&d.text(t.quantity),y&&(t==null?void 0:t.amount)!==void 0&&y.text(B(t.amount)),l&&e(l).val((t==null?void 0:t.id)??""),_&&e(_).val((t==null?void 0:t.item_desc)??""),p&&e(p).val((t==null?void 0:t.uom)??"");const h=n.find(".po-pr-number")[0],x=n.find(".po-pr-number-display");if(h&&(t!=null&&t.pr_number)&&e(h).val(t.pr_number),x.length&&(t!=null&&t.pr_number)&&x.text(t.pr_number).removeClass("text-gray-400").addClass("text-blue-600 dark:text-blue-400"),t!=null&&t.quantity&&n.find(".po-item-quantity").val(t.quantity),t!=null&&t.approved_date&&(n.find(".po-pr-approved-date").attr("data-pr-approved-date",t.approved_date),n.find(".po-pr-approved-date-display").text(E(t.approved_date))),(t==null?void 0:t.sla_po_to_onsite_target)!==void 0&&(t==null?void 0:t.sla_po_to_onsite_target)!==null&&n.find('input[name*="sla_po_to_onsite_target"]').val(t.sla_po_to_onsite_target),(t==null?void 0:t.sla_pr_to_po_realization)!==void 0&&(t==null?void 0:t.sla_pr_to_po_realization)!==null)n.find('input[name*="sla_pr_to_po_realization"]').val(t.sla_pr_to_po_realization);else{const v=e("#approved_date").val().trim();if(v&&(t!=null&&t.approved_date)){const A=Y(t.approved_date,v);n.find('input[name*="sla_pr_to_po_realization"]').val(A)}}q(n),O()}function j(){Object.keys(c).forEach(t=>{try{c[t]&&c[t].remove()}catch(a){console.warn("AutoNumeric removal warning:",a.message)}}),c={},e("#po-items-container tr").each(function(t){const a=e(this);let n=a.attr("data-row-id");n||(n=--H,a.attr("data-row-id",n));const i=a.find('input[name$="[unit_price]"]')[0],o=a.find('input[name$="[amount]"]')[0];if(i){if(i){const r=S.getAutoNumericElement(i);r?c[`unit_price_${n}`]=r:c[`unit_price_${n}`]=new S(i,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"}),e(i).off("input keyup blur autoNumeric:rawValueModified change").on("input keyup blur autoNumeric:rawValueModified change",function(){q(a)})}if(o){const r=S.getAutoNumericElement(o);r?c[`amount_${n}`]=r:c[`amount_${n}`]=new S(o,{currencySymbol:"",currencySymbolPlacement:"s",decimalCharacter:",",digitGroupSeparator:".",decimalPlaces:0,unformatOnSubmit:!0,minimumValue:"0"})}}})}function O(){e("#po-items-container tr").each(function(t){e(this).hasClass("text-gray-500")||e(this).find(".po-item-number").text(t+1)})}function X(){if(e("#po-items-container tr").not(".text-center.text-gray-500").length===0){const a=`
            <tr class="text-center text-gray-500">
                <td colspan="12" class="py-8">
                    <i class="mgc_inbox_line text-3xl mb-2"></i>
                    <p class="font-semibold">Klik "Ambil Data PR" untuk memuat items dari Purchase Request</p>
                    <p class="text-sm mt-1 text-amber-600 dark:text-amber-400">⚠️ Items harus diambil dari PR (minimal 1 item)</p>
                </td>
            </tr>
        `;e("#po-items-container").html(a),f.length>0&&N(f)}}function yt(t){Object.keys(t).forEach(a=>{const n=e(`#error-${a}`);n.length&&n.text(t[a][0]).removeClass("hidden")})}function U(t){e(`#error-${t}`).text("").addClass("hidden")}function vt(){e('[id^="error-"]').text("").addClass("hidden")}function q(t){const a=t.attr("data-row-id"),n=parseFloat(t.find(".po-item-quantity").val())||0,i=c[`unit_price_${a}`],o=c[`amount_${a}`];if(!i||!o)return;const r=i.getNumber()||0,s=n*r;o.set(s)}function wt(){e("#form-create-po").on("submit",async function(t){t.preventDefault(),vt();const a=xt();if(!a.isValid){$(a.message);return}const n=e("#po-items-container tr").not(".text-center.text-gray-500").length;if(a.lowSLACount>0&&a.lowSLACount<n&&!await T(`Terdapat ${a.lowSLACount} item dengan SLA Realisasi < 1 (tanggal PR lebih besar dari tanggal PO). Item tersebut tidak akan disimpan. Lanjutkan?`,"Konfirmasi Simpan dengan Item Bermasalah")||!await T("Data purchase order akan diupdate di sistem.","Konfirmasi Update"))return;const o=e(this).find('button[type="submit"]'),r=o.html();o.prop("disabled",!0).html('<i class="mgc_loading_line animate-spin me-2"></i>Mengupdate...');try{const s=new FormData(this),l=[];e("#po-items-container tr").not(".text-center.text-gray-500").each(function(w){const d=e(this),y=d.attr("data-row-id"),h=c[`unit_price_${y}`],x=c[`amount_${y}`],v=h?h.getNumber():0,A=x?x.getNumber():0,tt=parseFloat(d.find(".po-pr-amount").val())||0,z=d.find('input[name*="[id]"]').val();l.push({id:z&&z>0?z:null,purchase_request_item_id:d.find(".po-pr-item-id").val()||null,pr_amount:tt,unit_price:v,quantity:parseInt(d.find(".po-item-quantity").val())||0,amount:A,sla_po_to_onsite_target:d.find('input[name*="sla_po_to_onsite_target"]').val()||null,sla_pr_to_po_realization:d.find('input[name*="sla_pr_to_po_realization"]').val()||null})}),s.append("items",JSON.stringify(l));const p=await fetch(e(this).attr("action"),{method:"POST",headers:{Accept:"application/json"},body:s}),m=await p.json();if(!p.ok){m.errors&&yt(m.errors),$(m.message||"Gagal mengupdate PO");return}M("PO berhasil diupdate"),m.redirect?window.location.href=m.redirect:window.location.href=W("purchase-order.index")}catch(s){console.error("Error:",s),$("Terjadi kesalahan: "+s.message)}finally{o.prop("disabled",!1).html(r)}})}function xt(){const t=e("#po_number").val().trim(),a=e("#approved_date").val().trim(),n=e("#supplier_id").val(),i=e("#po-items-container tr").not(".text-center.text-gray-500"),o=i.length;if(!t)return{isValid:!1,message:"PO Number harus diisi",lowSLACount:0};if(!a)return{isValid:!1,message:"Approved Date harus diisi",lowSLACount:0};if(!n)return{isValid:!1,message:"Supplier harus dipilih",lowSLACount:0};if(o===0)return{isValid:!1,message:"Minimal harus ada 1 item dari PR. Klik 'Ambil Data PR' untuk menambah item.",lowSLACount:0};let r=0,s=!0,l="";return i.each(function(_){const p=e(this),m=p.attr("data-row-id"),w=c[`unit_price_${m}`],d=parseFloat(p.find(".po-item-quantity").val())||0,y=w?w.getNumber():0,h=p.find('input[name*="sla_po_to_onsite_target"]').val();if((parseFloat(p.find('input[name*="sla_pr_to_po_realization"]').val())||0)<1&&r++,y<=0)return s=!1,l=`Item ${_+1}: Harga satuan harus lebih dari 0`,!1;if(d<=0)return s=!1,l=`Item ${_+1}: Quantity harus lebih dari 0`,!1;if(!h||h===""||parseFloat(h)<=0)return s=!1,l=`Item ${_+1}: SLA Target harus diisi dan lebih dari 0`,!1}),s?r===o?{isValid:!1,message:"Semua item memiliki SLA Realisasi < 1. Tanggal Approved PO harus lebih besar dari tanggal Approved PR.",lowSLACount:r}:{isValid:!0,lowSLACount:r}:{isValid:!1,message:l,lowSLACount:r}}function kt(){e("#po_number").on("input",function(){U("po_number")}),e("#supplier_id").on("change",function(){U("supplier_id")})}function Pt(){k={po_number:e("#po_number").val().trim(),approved_date:e("#approved_date").val().trim(),supplier_id:e("#supplier_id").val(),notes:e("#notes").val().trim(),items:I()},Z(),g()}function Z(){P={po_number:e("#po_number").val().trim(),approved_date:e("#approved_date").val().trim(),supplier_id:e("#supplier_id").val(),notes:e("#notes").val().trim(),items:I()}}function I(){const t=[];return e("#po-items-container tr").not(".text-center.text-gray-500").each(function(){const a=e(this),n=a.attr("data-row-id"),i=c[`unit_price_${n}`],o=c[`amount_${n}`];t.push({id:a.find('input[name*="[id]"]').val(),pr_item_id:a.find(".po-pr-item-id").val(),unit_price:i?i.getNumber():0,quantity:a.find(".po-item-quantity").val(),amount:o?o.getNumber():0,sla_po_to_onsite_target:a.find('input[name*="sla_po_to_onsite_target"]').val(),sla_pr_to_po_realization:a.find('input[name*="sla_pr_to_po_realization"]').val()})}),JSON.stringify(t)}function St(){return Z(),G=k.po_number!==P.po_number||k.approved_date!==P.approved_date||k.supplier_id!==P.supplier_id||k.notes!==P.notes||k.items!==P.items,G}function g(){const t=St(),a=e("#form-create-po").find('button[type="submit"]');t?a.prop("disabled",!1).removeClass("opacity-50 cursor-not-allowed"):a.prop("disabled",!0).addClass("opacity-50 cursor-not-allowed")}function Ct(){e(document).on("input","#po_number",function(){g()}),e(document).on("input change","#approved_date",function(){g()}),e(document).on("change","#supplier_id",function(){g()}),e(document).on("input","#notes",function(){g()}),e(document).on("input change",'.po-item-quantity, input[name*="[unit_price]"], input[name*="[sla_po_to_onsite_target]"]',function(){g()});const t=window.deleteSelectedItems;window.deleteSelectedItems=async function(){await t.call(this),g()};const a=window.recalculateSLARealisasi;window.recalculateSLARealisasi=function(n){a.call(this,n),g()}}e(document).ready(function(){rt(),kt()});
