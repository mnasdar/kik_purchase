import{$ as e}from"./jquery-2823516c.js";import{f as N}from"./index-a4e39586.js";import{d as u,c as P,b as k}from"./notification-0e55581f.js";import"./_commonjsHelpers-725317a4.js";import"./pembayaran-edit-5f085df9.js";let S=0,l=[],d=[],v=!1;function f(t){if(t==null||t==="")return"-";const n=Number(t)||0;return new Intl.NumberFormat("id-ID").format(n)}function $(t,n){if(!t||!n)return 0;const a=new Date(t),i=new Date(n);if(a.setHours(0,0,0,0),i.setHours(0,0,0,0),i<a)return 0;let c=0;const o=new Date(a);for(;o<=i;){const s=o.getDay();s!==0&&s!==6&&c++,o.setDate(o.getDate()+1)}return c}function L(){e("#form-create-pembayaran").length&&(A(),T(),X())}function A(){e(document).on("click",".pembayaran-btn-remove-item",function(){const t=e(this).closest("tr");t.find(".pembayaran-invoice-id").val();const n=t.attr("data-row-id"),a=d.findIndex(i=>i.rowId===n);a!==-1&&(d[a].instance&&d[a].instance.destroy(),d.splice(a,1)),t.remove(),I(),C(),l.length>0&&y(l)}),M(),e(document).on("click","#btn-delete-selected-items",function(){R()}),J()}function M(){e(document).off("change","#item-select-all").on("change","#item-select-all",function(){e(".item-checkbox").prop("checked",this.checked),b()}),e(document).off("change",".item-checkbox").on("change",".item-checkbox",function(){const t=e(".item-checkbox").length===e(".item-checkbox:checked").length;e("#item-select-all").prop("checked",t),b()})}function b(){const t=e(".item-checkbox:checked").length,n=e("#btn-delete-selected-items");t>0?(n.removeClass("hidden"),e("#selected-items-count").text(t)):n.addClass("hidden")}async function R(){const t=e(".item-checkbox:checked").closest("tr"),n=t.length;if(n===0){u("Tidak ada item yang dipilih");return}await P(`Apakah Anda yakin ingin menghapus ${n} item terpilih?`,"Konfirmasi Hapus")&&(t.each(function(){const i=e(this).attr("data-row-id"),c=d.findIndex(o=>o.rowId===i);c!==-1&&(d[c].instance&&d[c].instance.destroy(),d.splice(c,1))}),t.remove(),I(),e("#item-select-all").prop("checked",!1),b(),C(),l.length>0&&y(l),k(`${n} item berhasil dihapus`))}function T(){e(document).off("click","#btn-pick-invoice").on("click","#btn-pick-invoice",async function(){await F(),j()}),e(document).off("click","#btn-close-invoice-modal").on("click","#btn-close-invoice-modal",function(){D()}),e(document).off("click",".btn-select-invoice").on("click",".btn-select-invoice",function(t){t.preventDefault(),t.stopPropagation();const n=e(this);if(n.prop("disabled"))return;n.prop("disabled",!0);const a=n.data("invoice-id"),i=l.find(c=>c.id==a);i&&(H(i),D()),setTimeout(()=>n.prop("disabled",!1),500)})}let w=[],r=1,p=10,m=[];async function F(){try{const t=await fetch("/invoice/pembayaran/get-invoices",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}});if(!t.ok)throw new Error("Gagal memuat data invoice");const n=await t.json();l=n,y(n)}catch(t){console.error("Error loading invoices:",t),u("Gagal memuat data invoice")}}function y(t){w=t;const n=[];if(e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const a=e(this).val(),i=Number(a);!Number.isNaN(i)&&i>0&&n.push(i)}),m=t.filter(a=>!n.includes(a.id)),r=1,e("#invoice-total").text(m.length),!m.length){e("#invoice-list-body").html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang tersedia atau semua sudah ditambahkan
                </td>
            </tr>
        `);return}h(r),B(),E()}function h(t){const n=(t-1)*p,a=n+p,i=m.slice(n,a),c=e("#invoice-list-body");if(c.empty(),!i.length){c.html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang cocok dengan pencarian
                </td>
            </tr>
        `);return}i.forEach(o=>{const s=`
            <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/30">
                <td class="px-3 py-2 text-left">
                    <span class="font-medium text-blue-600 dark:text-blue-400">${o.invoice_number}</span>
                </td>
                <td class="px-3 py-2 text-left">${o.po_number}</td>
                <td class="px-3 py-2 text-left">${o.pr_number}</td>
                <td class="px-3 py-2 text-left text-xs">${o.item_desc}</td>
                <td class="px-3 py-2 text-right">${f(o.unit_price)}</td>
                <td class="px-3 py-2 text-center">${o.quantity??"-"}</td>
                <td class="px-3 py-2 text-right font-semibold">${f(o.amount)}</td>
                <td class="px-3 py-2 text-center">
                    <button type="button" class="btn-select-invoice btn btn-sm bg-primary text-white hover:bg-primary-600"
                        data-invoice-id="${o.id}">
                        <i class="mgc_check_line me-1"></i>Pilih
                    </button>
                </td>
            </tr>
        `;c.append(s)}),e("#invoice-count").text(i.length),q()}function q(){const t=Math.ceil(m.length/p)||1;e("#invoice-current-page").text(r),e("#invoice-total-pages").text(t),e("#invoice-per-page").text(p),e("#btn-invoice-prev").prop("disabled",r<=1),e("#btn-invoice-next").prop("disabled",r>=t)}function B(){e(document).off("input","#invoice-search-input").on("input","#invoice-search-input",function(){const t=e(this).val().toLowerCase().trim(),n=[];e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const a=e(this).val(),i=Number(a);!Number.isNaN(i)&&i>0&&n.push(i)}),t===""?m=w.filter(a=>!n.includes(Number(a.id))):m=w.filter(a=>n.includes(Number(a.id))?!1:(a.invoice_number||"").toLowerCase().includes(t)||(a.po_number||"").toLowerCase().includes(t)||(a.pr_number||"").toLowerCase().includes(t)||(a.item_desc||"").toLowerCase().includes(t)),r=1,e("#invoice-total").text(m.length),h(r)})}function E(){e(document).off("click","#btn-invoice-prev").on("click","#btn-invoice-prev",function(){r>1&&(r--,h(r))}),e(document).off("click","#btn-invoice-next").on("click","#btn-invoice-next",function(){const t=Math.ceil(m.length/p);r<t&&(r++,h(r))})}function j(){e("#modal-pick-invoice").removeClass("hidden")}function D(){e("#modal-pick-invoice").addClass("hidden")}function H(t){e("#pembayaran-items-container tr.text-center.text-gray-500").remove();const n=[];if(e("#pembayaran-items-container tr.pembayaran-item-row .pembayaran-invoice-id").each(function(){const a=e(this).val(),i=Number(a);!Number.isNaN(i)&&i>0&&n.push(i)}),n.includes(Number(t.id))){u("Invoice ini sudah ditambahkan");return}W(t),y(l),I(),e("#item-select-all").prop("checked",!1),b(),k(`Invoice ${t.invoice_number} berhasil ditambahkan`)}function W(t){const n=e("#pembayaran-item-row-template").html(),a=e(n),i=S++,c="row-"+i;a.attr("data-row-id",c),a.find("input, select").each(function(){const s=e(this).attr("name");s&&e(this).attr("name",s.replace("[0]",`[${i}]`))}),e("#pembayaran-items-container").append(a),a.find(".pembayaran-invoice-id").val(t.id),a.find(".pembayaran-invoice-number").text(t.invoice_number),a.find(".pembayaran-po-number").text(t.po_number),a.find(".pembayaran-pr-number").text(t.pr_number),a.find(".pembayaran-item-desc").text(t.item_desc),a.find(".pembayaran-unit-price").text(f(t.unit_price)),a.find(".pembayaran-qty").text(t.quantity),a.find(".pembayaran-amount").text(f(t.amount)),t.submitted_at&&(a.find(".pembayaran-submitted-at").val(t.submitted_at),a.find(".pembayaran-submitted-date").text(O(t.submitted_at)));const o=e("#payment_date").val();if(o&&t.submitted_at){const s=$(t.submitted_at,o);a.find(".pembayaran-sla-display").text(s+" hari"),a.find(".pembayaran-sla-input").val(s)}}function O(t){if(!t)return"-";const n=new Date(t),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],i=n.getDate(),c=a[n.getMonth()],o=n.getFullYear().toString().substr(-2);return`${i}-${c}-${o}`}function I(){e("#pembayaran-items-container tr.pembayaran-item-row").each(function(t){e(this).find(".pembayaran-item-number").text(t+1),e(this).find("input, select, textarea").each(function(){const n=e(this).attr("name");if(!n)return;const a=n.replace(/items\[\d+\]/,`items[${t}]`);e(this).attr("name",a)})})}function C(){if(e("#pembayaran-items-container tr").not(".text-center.text-gray-500").length===0){const n=`
            <tr class="text-center text-gray-500">
                <td colspan="12" class="border px-4 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="mgc_inbox_line text-4xl text-gray-400"></i>
                        <p class="text-sm">Belum ada invoice yang dipilih</p>
                        <p class="text-xs text-gray-400">Klik tombol "Pilih Invoice" untuk memulai</p>
                    </div>
                </td>
            </tr>
        `;e("#pembayaran-items-container").html(n)}}function X(){const t=document.getElementById("payment_date");t&&N(t,{altInput:!0,altFormat:"d-M-y",dateFormat:"Y-m-d",allowInput:!0,locale:{firstDayOfWeek:1},onChange:function(n,a){G()}})}function G(){const t=e("#payment_date").val();if(!t){e(".pembayaran-sla-display").text("-"),e(".pembayaran-sla-input").val("");return}e("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const n=e(this),a=n.find(".pembayaran-submitted-at").val();if(a){const i=$(a,t);n.find(".pembayaran-sla-display").text(i+" hari"),n.find(".pembayaran-sla-input").val(i)}else n.find(".pembayaran-sla-display").text("-"),n.find(".pembayaran-sla-input").val("")})}function J(){e("#form-create-pembayaran").off("submit").on("submit",async function(t){if(t.preventDefault(),v)return console.log("Form is already being submitted..."),!1;if(!K())return!1;v=!0;const n=new FormData(this),a=e("#payment_number").val(),i=e("#payment_date").val();e("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const _=(e(this).find(".pembayaran-invoice-id").attr("name")||"").match(/items\[(\d+)\]/),g=_?_[1]:null;g!==null&&(a&&n.set(`items[${g}][payment_number]`,a),n.set(`items[${g}][payment_date]`,i))});const c=e(this).find('button[type="submit"]'),o=c.html();c.prop("disabled",!0).html('<i class="mgc_loading_line animate-spin me-2"></i>Menyimpan...');try{const s=await fetch(this.action,{method:"POST",body:n,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}),x=await s.json();if(!s.ok)throw new Error(x.message||"Gagal menyimpan pembayaran");k(x.message||"Pembayaran berhasil disimpan"),setTimeout(()=>{window.location.href="/invoice/pembayaran"},1e3)}catch(s){u(s.message),c.prop("disabled",!1).html(o),v=!1}})}function K(){if(e("#pembayaran-items-container tr.pembayaran-item-row").length===0)return u("Belum ada invoice yang dipilih. Silakan pilih minimal 1 invoice."),!1;const n=e("#payment_date").val();return!n||n.trim()===""?(u("Payment Date wajib diisi"),e("#payment_date").focus(),!1):!0}e(document).ready(function(){L()});
