import{$ as e}from"./jquery-2823516c.js";import{a as R,K as _}from"./gridjs.module-3ea5c5ab.js";import{s as D}from"./index-88056f3d.js";import{s as b,d as m,c as q,b as P}from"./notification-0e55581f.js";import{f as j}from"./index-a4e39586.js";import"./_commonjsHelpers-725317a4.js";import"./parse-c3570fb2.js";import"./pembayaran-edit-5f085df9.js";let f=null,$=[],d=[];function T(t=!1){e.ajax({url:D("pembayaran.data"),method:"GET",beforeSend:function(){t&&b("Memuat data pembayaran...","info",2e3)},success:function(a){$=a,G(),O(a),t&&b("Data pembayaran berhasil dimuat","success",2e3)},error:function(){m("Gagal memuat data pembayaran","Error!")}})}function O(t){const a=t.length,n=t.filter(c=>c.payment_date&&c.payment_date!=="-").length,i=a-n;e("#stat-total").text(a),e("#stat-paid").text(n),e("#stat-pending").text(i)}function H(){return[{id:"checkbox",name:_('<input type="checkbox" id="headerCheck" class="form-checkbox rounded text-primary">'),width:"50px",sort:!1,formatter:t=>_(t)},{id:"id",name:"ID",hidden:!0},{id:"payment_number",name:"No Payment",width:"130px"},{id:"po_number",name:"PO Number",width:"130px"},{id:"item_desc",name:"Item Description",width:"200px"},{id:"unit_price",name:"Unit Price",width:"110px"},{id:"qty",name:"Qty",width:"70px"},{id:"amount",name:"Amount",width:"120px"},{id:"invoice_submit",name:"Invoice Submit",width:"130px"},{id:"payment_date",name:"Payment Date",width:"120px"},{id:"sla_payment",name:"SLA",width:"90px"},{id:"created_by",name:"Created By",width:"130px"},{id:"actions",name:"Aksi",width:"120px",sort:!1,formatter:(t,a)=>{const n=a.cells[1].data,i=a.cells[2].data||"-";return _(`<button class="btn-detail-pembayaran inline-flex items-center px-2 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-xs mr-1" data-id="${n}" title="Detail"><i class="mgc_eye_line"></i></button><a href="${D("pembayaran.edit",n)}" class="inline-flex items-center px-2 py-1 rounded bg-yellow-500 hover:bg-yellow-600 text-white text-xs mr-1" title="Edit"><i class="mgc_edit_line"></i></a><button class="btn-delete-pembayaran inline-flex items-center px-2 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-xs" data-id="${n}" data-number="${i}" title="Delete"><i class="mgc_delete_2_line"></i></button>`)}}]}function G(){const t=$.map(n=>[`<input type="checkbox" class="form-checkbox rounded text-primary row-checkbox" value="${n.id}">`,n.id,n.payment_number||"-",n.po_number||"-",n.item_desc||"-",n.unit_price||"-",n.qty||"-",n.amount||"-",n.invoice_submit||"-",n.payment_date||"-",n.sla_payment||"-",n.created_by||"-",""]);if(f){try{f.destroy()}catch(n){console.warn("Error destroying grid:",n)}f=null}const a=document.getElementById("table-pembayaran");a&&(a.innerHTML=""),f=new R({columns:H(),data:t,search:{enabled:!0,keyword:""},pagination:{limit:15,summary:!0},sort:{multiColumn:!0},fixedHeader:!0,height:"600px",style:{table:{"white-space":"nowrap"},td:{padding:"8px 12px","line-height":"1.4"},th:{padding:"8px 12px"}},className:{table:"table table-bordered table-hover"},language:{search:{placeholder:"Cari..."},pagination:{previous:"Sebelumnya",next:"Selanjutnya",showing:"Menampilkan",of:"dari",to:"sampai",results:"data"},noRecordsFound:"Tidak ada data",loading:"Memuat..."}}),f.render(a),setTimeout(()=>{X()},100)}function X(){e(document).off("change","#headerCheck").on("change","#headerCheck",function(){const t=e(this).is(":checked");e(".row-checkbox").prop("checked",t).trigger("change")}),e(document).off("change",".row-checkbox").on("change",".row-checkbox",function(){W(),J()}),e(document).off("click",".btn-detail-pembayaran").on("click",".btn-detail-pembayaran",function(){const t=e(this).data("id");K(t)}),e(document).off("click",".btn-delete-pembayaran").on("click",".btn-delete-pembayaran",function(){const t=e(this).data("id"),a=e(this).data("number");A([t],`Apakah Anda yakin ingin menghapus pembayaran "${a}"?`)})}function W(){d=[],e(".row-checkbox:checked").each(function(){d.push(e(this).val())})}function J(){d.length>0?e("#btn-delete-selected").removeClass("hidden").prop("disabled",!1):e("#btn-delete-selected").addClass("hidden").prop("disabled",!0)}function A(t,a="Apakah Anda yakin ingin menghapus data ini?"){d=t,e("#deleteMessage").text(a);const n=e("#deleteModal"),i=e("#deleteModalBackdrop"),c=e("#deleteModalContent");n.removeClass("hidden").css("opacity","1"),requestAnimationFrame(()=>{i.css("opacity","1"),c.css({transform:"scale(1)",opacity:"1"})})}function h(){const t=e("#deleteModalBackdrop"),a=e("#deleteModalContent");t.css("opacity","0"),a.css({transform:"scale(0.95)",opacity:"0"}),setTimeout(()=>{e("#deleteModal").addClass("hidden").css("opacity","0")},300)}function K(t){const a=$.find(o=>o.id==t);if(!a)return;e("#detailPaymentNumber").text(a.payment_number||"-"),e("#detailPaymentDate").text(a.payment_date||"-"),e("#detailPaymentSLAPayment").text(a.sla_payment||"-"),e("#detailInvoiceNumber").text(a.invoice_number||"-"),e("#detailPONumber").text(a.po_number||"-"),e("#detailPRNumber").text(a.pr_number||"-"),e("#detailCreatedBy").text(a.created_by||"-");const n=e("#detailPembayaranModal"),i=e("#detailPembayaranModalBackdrop"),c=e("#detailPembayaranModalContent");n.removeClass("hidden").css("opacity","1"),requestAnimationFrame(()=>{i.css("opacity","1"),c.css({transform:"scale(1)",opacity:"1"})})}function M(){const t=e("#detailPembayaranModalBackdrop"),a=e("#detailPembayaranModalContent");t.css("opacity","0"),a.css({transform:"scale(0.95)",opacity:"0"}),setTimeout(()=>{e("#detailPembayaranModal").addClass("hidden").css("opacity","0")},300)}function Y(){T(!1)}function z(){e(document).off("click","#btn-refresh").on("click","#btn-refresh",function(){T(!0)})}function Q(){e(document).off("click","#btn-delete-selected").on("click","#btn-delete-selected",function(){if(d.length===0){b("Pilih minimal 1 pembayaran untuk dihapus","warning",2e3);return}A(d,`Apakah Anda yakin ingin menghapus ${d.length} pembayaran?`)}),e(document).off("click","#deleteModalConfirm").on("click","#deleteModalConfirm",async function(){var n;const t=e(this),a=t.text();t.prop("disabled",!0).text("Menghapus...");try{await e.ajax({url:D("pembayaran.bulk-destroy"),method:"DELETE",data:{ids:d},headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")}}),h(),b("Pembayaran berhasil dihapus!","success",2e3),d=[],setTimeout(()=>T(!1),500)}catch(i){m(((n=i==null?void 0:i.responseJSON)==null?void 0:n.message)||"Gagal menghapus pembayaran","Gagal!")}finally{t.prop("disabled",!1).text(a)}}),e(document).off("click","#deleteModalCancel, #deleteModalClose").on("click","#deleteModalCancel, #deleteModalClose",h),e(document).off("click","#deleteModal").on("click","#deleteModal",function(t){e(t.target).is("#deleteModal")&&h()}),e(document).off("keydown.pembayaran-delete").on("keydown.pembayaran-delete",function(t){t.key==="Escape"&&!e("#deleteModal").hasClass("hidden")&&h()})}function U(){e(document).off("click","#detailPembayaranModalClose").on("click","#detailPembayaranModalClose",M),e(document).off("click","#detailPembayaranModal").on("click","#detailPembayaranModal",function(t){e(t.target).is("#detailPembayaranModal")&&M()}),e(document).off("keydown.pembayaran-detail").on("keydown.pembayaran-detail",function(t){t.key==="Escape"&&!e("#detailPembayaranModal").hasClass("hidden")&&M()})}let V=0,p=[],u=[];function x(t){if(t==null||t==="")return"-";const a=Number(t)||0;return new Intl.NumberFormat("id-ID").format(a)}function B(t,a){if(!t||!a)return 0;const n=new Date(t),i=new Date(a);if(n.setHours(0,0,0,0),i.setHours(0,0,0,0),i<n)return 0;let c=0;const o=new Date(n);for(;o<=i;){const s=o.getDay();s!==0&&s!==6&&c++,o.setDate(o.getDate()+1)}return c}function F(){e("#form-create-pembayaran").length&&(Z(),ae(),me())}function Z(){e(document).on("click",".pembayaran-btn-remove-item",function(){const t=e(this).closest("tr");t.find(".pembayaran-invoice-id").val();const a=t.attr("data-row-id"),n=u.findIndex(i=>i.rowId===a);n!==-1&&(u[n].instance&&u[n].instance.destroy(),u.splice(n,1)),t.remove(),N(),L(),p.length>0&&v(p)}),ee(),e(document).on("click","#btn-delete-selected-items",function(){te()}),pe()}function ee(){e(document).off("change","#item-select-all").on("change","#item-select-all",function(){e(".item-checkbox").prop("checked",this.checked),g()}),e(document).off("change",".item-checkbox").on("change",".item-checkbox",function(){const t=e(".item-checkbox").length===e(".item-checkbox:checked").length;e("#item-select-all").prop("checked",t),g()})}function g(){const t=e(".item-checkbox:checked").length,a=e("#btn-delete-selected-items");t>0?(a.removeClass("hidden"),e("#selected-items-count").text(t)):a.addClass("hidden")}async function te(){const t=e(".item-checkbox:checked").closest("tr"),a=t.length;if(a===0){m("Tidak ada item yang dipilih");return}await q(`Apakah Anda yakin ingin menghapus ${a} item terpilih?`,"Konfirmasi Hapus")&&(t.each(function(){const i=e(this).attr("data-row-id"),c=u.findIndex(o=>o.rowId===i);c!==-1&&(u[c].instance&&u[c].instance.destroy(),u.splice(c,1))}),t.remove(),N(),e("#item-select-all").prop("checked",!1),g(),L(),p.length>0&&v(p),P(`${a} item berhasil dihapus`))}function ae(){e(document).off("click","#btn-pick-invoice").on("click","#btn-pick-invoice",async function(){await ne(),se()}),e(document).off("click","#btn-close-invoice-modal").on("click","#btn-close-invoice-modal",function(){E()}),e(document).off("click",".btn-select-invoice").on("click",".btn-select-invoice",function(t){t.preventDefault(),t.stopPropagation();const a=e(this);if(a.prop("disabled"))return;a.prop("disabled",!0);const n=a.data("invoice-id"),i=p.find(c=>c.id==n);i&&(re(i),E()),setTimeout(()=>a.prop("disabled",!1),500)})}let C=[],r=1,y=10,l=[];async function ne(){try{const t=await fetch("/invoice/pembayaran/get-invoices",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}});if(!t.ok)throw new Error("Gagal memuat data invoice");const a=await t.json();p=a,v(a)}catch(t){console.error("Error loading invoices:",t),m("Gagal memuat data invoice")}}function v(t){C=t;const a=[];if(e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const n=e(this).val(),i=Number(n);!Number.isNaN(i)&&i>0&&a.push(i)}),l=t.filter(n=>!a.includes(n.id)),r=1,e("#invoice-total").text(l.length),!l.length){e("#invoice-list-body").html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang tersedia atau semua sudah ditambahkan
                </td>
            </tr>
        `);return}k(r),oe(),ce()}function k(t){const a=(t-1)*y,n=a+y,i=l.slice(a,n),c=e("#invoice-list-body");if(c.empty(),!i.length){c.html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang cocok dengan pencarian
                </td>
            </tr>
        `);return}i.forEach(o=>{const s=`
            <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/30">
                <td class="px-3 py-2 text-left">
                    <span class="font-medium text-blue-600 dark:text-blue-400">${o.invoice_number}</span>
                </td>
                <td class="px-3 py-2 text-left">${o.po_number}</td>
                <td class="px-3 py-2 text-left">${o.pr_number}</td>
                <td class="px-3 py-2 text-left text-xs">${o.item_desc}</td>
                <td class="px-3 py-2 text-right">${x(o.unit_price)}</td>
                <td class="px-3 py-2 text-center">${o.quantity??"-"}</td>
                <td class="px-3 py-2 text-right font-semibold">${x(o.amount)}</td>
                <td class="px-3 py-2 text-center">
                    <button type="button" class="btn-select-invoice btn btn-sm bg-primary text-white hover:bg-primary-600"
                        data-invoice-id="${o.id}">
                        <i class="mgc_check_line me-1"></i>Pilih
                    </button>
                </td>
            </tr>
        `;c.append(s)}),e("#invoice-count").text(i.length),ie()}function ie(){const t=Math.ceil(l.length/y)||1;e("#invoice-current-page").text(r),e("#invoice-total-pages").text(t),e("#invoice-per-page").text(y),e("#btn-invoice-prev").prop("disabled",r<=1),e("#btn-invoice-next").prop("disabled",r>=t)}function oe(){e(document).off("input","#invoice-search-input").on("input","#invoice-search-input",function(){const t=e(this).val().toLowerCase().trim(),a=[];e("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const n=e(this).val(),i=Number(n);!Number.isNaN(i)&&i>0&&a.push(i)}),t===""?l=C.filter(n=>!a.includes(Number(n.id))):l=C.filter(n=>a.includes(Number(n.id))?!1:(n.invoice_number||"").toLowerCase().includes(t)||(n.po_number||"").toLowerCase().includes(t)||(n.pr_number||"").toLowerCase().includes(t)||(n.item_desc||"").toLowerCase().includes(t)),r=1,e("#invoice-total").text(l.length),k(r)})}function ce(){e(document).off("click","#btn-invoice-prev").on("click","#btn-invoice-prev",function(){r>1&&(r--,k(r))}),e(document).off("click","#btn-invoice-next").on("click","#btn-invoice-next",function(){const t=Math.ceil(l.length/y);r<t&&(r++,k(r))})}function se(){e("#modal-pick-invoice").removeClass("hidden")}function E(){e("#modal-pick-invoice").addClass("hidden")}function re(t){e("#pembayaran-items-container tr.text-center.text-gray-500").remove();const a=[];if(e("#pembayaran-items-container tr.pembayaran-item-row .pembayaran-invoice-id").each(function(){const n=e(this).val(),i=Number(n);!Number.isNaN(i)&&i>0&&a.push(i)}),a.includes(Number(t.id))){m("Invoice ini sudah ditambahkan");return}de(t),v(p),N(),e("#item-select-all").prop("checked",!1),g(),P(`Invoice ${t.invoice_number} berhasil ditambahkan`)}function de(t){const a=e("#pembayaran-item-row-template").html(),n=e(a),i=V++,c="row-"+i;n.attr("data-row-id",c),n.find("input, select").each(function(){const s=e(this).attr("name");s&&e(this).attr("name",s.replace("[0]",`[${i}]`))}),e("#pembayaran-items-container").append(n),n.find(".pembayaran-invoice-id").val(t.id),n.find(".pembayaran-invoice-number").text(t.invoice_number),n.find(".pembayaran-po-number").text(t.po_number),n.find(".pembayaran-pr-number").text(t.pr_number),n.find(".pembayaran-item-desc").text(t.item_desc),n.find(".pembayaran-unit-price").text(x(t.unit_price)),n.find(".pembayaran-qty").text(t.quantity),n.find(".pembayaran-amount").text(x(t.amount)),t.submitted_at&&(n.find(".pembayaran-submitted-at").val(t.submitted_at),n.find(".pembayaran-submitted-date").text(le(t.submitted_at)));const o=e("#payment_date").val();if(o&&t.submitted_at){const s=B(t.submitted_at,o);n.find(".pembayaran-sla-display").text(s+" hari"),n.find(".pembayaran-sla-input").val(s)}}function le(t){if(!t)return"-";const a=new Date(t),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],i=a.getDate(),c=n[a.getMonth()],o=a.getFullYear().toString().substr(-2);return`${i}-${c}-${o}`}function N(){e("#pembayaran-items-container tr.pembayaran-item-row").each(function(t){e(this).find(".pembayaran-item-number").text(t+1),e(this).find("input, select, textarea").each(function(){const a=e(this).attr("name");if(!a)return;const n=a.replace(/items\[\d+\]/,`items[${t}]`);e(this).attr("name",n)})})}function L(){if(e("#pembayaran-items-container tr").not(".text-center.text-gray-500").length===0){const a=`
            <tr class="text-center text-gray-500">
                <td colspan="12" class="border px-4 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="mgc_inbox_line text-4xl text-gray-400"></i>
                        <p class="text-sm">Belum ada invoice yang dipilih</p>
                        <p class="text-xs text-gray-400">Klik tombol "Pilih Invoice" untuk memulai</p>
                    </div>
                </td>
            </tr>
        `;e("#pembayaran-items-container").html(a)}}function me(){const t=document.getElementById("payment_date");t&&j(t,{altInput:!0,altFormat:"d-M-y",dateFormat:"Y-m-d",allowInput:!0,locale:{firstDayOfWeek:1},onChange:function(a,n){ue()}})}function ue(){const t=e("#payment_date").val();if(!t){e(".pembayaran-sla-display").text("-"),e(".pembayaran-sla-input").val("");return}e("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const a=e(this),n=a.find(".pembayaran-submitted-at").val();if(n){const i=B(n,t);a.find(".pembayaran-sla-display").text(i+" hari"),a.find(".pembayaran-sla-input").val(i)}else a.find(".pembayaran-sla-display").text("-"),a.find(".pembayaran-sla-input").val("")})}function pe(){e("#form-create-pembayaran").on("submit",async function(t){if(t.preventDefault(),!fe())return;const a=new FormData(this),n=e("#payment_number").val(),i=e("#payment_date").val();e("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const S=(e(this).find(".pembayaran-invoice-id").attr("name")||"").match(/items\[(\d+)\]/),I=S?S[1]:null;I!==null&&(n&&a.set(`items[${I}][payment_number]`,n),a.set(`items[${I}][payment_date]`,i))});const c=e(this).find('button[type="submit"]'),o=c.html();c.prop("disabled",!0).html('<i class="mgc_loading_line animate-spin me-2"></i>Menyimpan...');try{const s=await fetch(this.action,{method:"POST",body:a,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}),w=await s.json();if(!s.ok)throw new Error(w.message||"Gagal menyimpan pembayaran");P(w.message||"Pembayaran berhasil disimpan"),setTimeout(()=>{window.location.href="/invoice/pembayaran"},1e3)}catch(s){m(s.message),c.prop("disabled",!1).html(o)}})}function fe(){if(e("#pembayaran-items-container tr.pembayaran-item-row").length===0)return m("Belum ada invoice yang dipilih. Silakan pilih minimal 1 invoice."),!1;const a=e("#payment_date").val();return!a||a.trim()===""?(m("Payment Date wajib diisi"),e("#payment_date").focus(),!1):!0}e(document).ready(function(){F()});function be(){const t=document.getElementById("payment_date");t&&typeof flatpickr<"u"&&flatpickr(t,{enableTime:!1,dateFormat:"Y-m-d",locale:"id"})}function ye(){const t=document.getElementById("pembayaranForm");t&&t.addEventListener("submit",function(a){a.preventDefault();const n=new FormData(this),i=this.querySelector('button[type="submit"]'),c=i.textContent;i.disabled=!0,i.textContent="Menyimpan...",fetch(this.action,{method:"POST",body:n,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(o=>o.ok?o.json():o.json().then(s=>{throw{status:o.status,data:s}})).then(o=>{b("Pembayaran berhasil diperbarui","success"),setTimeout(()=>{window.location.href="/pembayaran"},1e3)}).catch(o=>{let s="Terjadi kesalahan saat memperbarui pembayaran";o.data&&(o.data.message?s=o.data.message:o.data.errors&&(s=Object.values(o.data.errors).flat().join(", "))),m(s),i.disabled=!1,i.textContent=c})})}function he(){be(),ye()}e(document).ready(function(){const t=document.getElementById("form-create-pembayaran"),a=document.getElementById("pembayaranForm");t?F():a?he():document.querySelector("[data-table-init]")&&(Y(),z(),Q(),U())});
