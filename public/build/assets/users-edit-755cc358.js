import{$ as e}from"./modal-handler-2823516c.js";import{s as M}from"./index-88056f3d.js";import{N as m}from"./nice-select2-6e0cfbe7.js";import{a as v,b as R}from"./notification-d92c8c7c.js";import"./_commonjsHelpers-725317a4.js";import"./parse-c3570fb2.js";import"./notification-5f085df9.js";let f=null,h=null,w=null;function S(s){const t=e(s),l=t.next(".nice-select");l.length&&l.remove(),t.css({opacity:"",width:"",padding:"",height:"",display:""})}function E(){const s=e("#userRole");S(s),f&&f.destroy(),typeof m<"u"&&(f=new m(s[0],{searchable:!0,placeholder:"-- Pilih Role --"}))}function j(){const s=e("#userStatus");S(s),h&&h.destroy(),typeof m<"u"&&(h=new m(s[0],{searchable:!0,placeholder:"-- Pilih Status --"}))}function P(){const s=e("#userLocation");S(s),w&&w.destroy(),typeof m<"u"&&(w=new m(s[0],{searchable:!0,placeholder:"-- Pilih Location --"}))}function T(){e("#form-user")[0].reset(),e("#userId").val(""),e("#userMethod").val("POST");const s=e("#userPassword").closest(".space-y-2"),t=e("#userPasswordConfirmation").closest(".space-y-2");s.removeClass("hidden"),t.removeClass("hidden"),s.find("label span.text-red-500").show(),t.find("label span.text-red-500").show(),e("p[id^='error-']").text("")}function N(){const s=e("#userModal"),t=e("#userModalBackdrop"),l=e("#userModalContent");t.css("opacity","0"),l.css({transform:"scale(0.95)",opacity:"0"}),setTimeout(()=>{s.addClass("hidden").removeClass("flex").css("opacity","0")},300)}e(document).on("click",".btn-edit-user",async function(){const s=e(this).data("user-id"),t=e(this),l=t.html();try{t.addClass("pointer-events-none opacity-60"),t.html('<i class="mgc_refresh_2_line animate-spin"></i>'),T(),e("#userMethod").val("PUT"),e("#userModalTitle").text("Edit User"),e("#userModalIcon").removeClass("mgc_user_add_line").addClass("mgc_user_edit_line");const u=e("#userPassword").closest(".space-y-2"),o=e("#userPasswordConfirmation").closest(".space-y-2");u.addClass("hidden"),o.addClass("hidden"),e("#passwordRequired").text(""),e("#passwordConfirmRequired").text("");const c=e("#userModal"),b=e("#userModalBackdrop"),g=e("#userModalContent");c.removeClass("hidden").addClass("flex").css("opacity","1"),requestAnimationFrame(()=>{b.css("opacity","1"),g.css({transform:"scale(1)",opacity:"1"})});const p=await fetch(M("users.show",{user:s}),{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}),i=await p.text();let r={};try{r=i?JSON.parse(i):{}}catch(y){throw console.error("Failed to parse JSON response",y,i),new Error("Respon server tidak valid")}if(!p.ok)throw new Error(r.message||"Gagal mengambil data user");e("#userId").val(r.id),e("#userName").val(r.name),e("#userEmail").val(r.email),e("#userLocation").val(r.location_id||""),e("#userRole").val(r.role_id||""),e("#userStatus").val(r.is_active?"1":"0"),w&&w.update(),f&&f.update(),h&&h.update()}catch(u){console.error("Error loading user:",u),v("Gagal memuat data user"),N()}finally{t.removeClass("pointer-events-none opacity-60"),t.html(l)}});e("#form-user").on("submit",async function(s){s.preventDefault();const t=e("#userId").val();if(!t)return;const u=M("users.update",{user:t}),o=new FormData(this),c=e(this).find('button[type="submit"]'),b=c.html();e("p[id^='error-']").text("");const g=o.get("name");if(!g||g.trim()===""){e("#error-name").html('<i class="mgc_info_line mr-1"></i>Nama user wajib diisi');return}const p=o.get("email");if(!p||p.trim()===""){e("#error-email").html('<i class="mgc_info_line mr-1"></i>Email wajib diisi');return}const i=o.get("password"),r=o.get("password_confirmation");if(i&&i.trim()!==""){if(i.length<8){e("#error-password").html('<i class="mgc_info_line mr-1"></i>Password minimal 8 karakter');return}if(!r||r.trim()===""){e("#error-password_confirmation").html('<i class="mgc_info_line mr-1"></i>Konfirmasi password wajib diisi jika mengubah password');return}if(i!==r){e("#error-password_confirmation").html('<i class="mgc_info_line mr-1"></i>Password tidak sesuai dengan konfirmasi');return}}const y=o.get("role");if(!y||y.trim()===""){e("#error-role").html('<i class="mgc_info_line mr-1"></i>Role wajib dipilih');return}const k=o.get("is_active");if(!k||k.trim()===""){e("#error-is_active").html('<i class="mgc_info_line mr-1"></i>Status wajib dipilih');return}const C={};for(let[a,n]of o.entries())a==="password"||a==="password_confirmation"?n&&n.trim()!==""&&(C[a]=n):C[a]=n;c.prop("disabled",!0),c.html('<i class="mgc_loading_line animate-spin mr-2"></i>Menyimpan...');try{const a=await fetch(u,{method:"PUT",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(C)}),n=await a.text();let d={};try{d=n?JSON.parse(n):{}}catch(_){console.error("Failed to parse JSON response",_,n),v("Respon server tidak valid. Silakan coba lagi.");return}if(!a.ok){d.errors?Object.keys(d.errors).forEach(_=>{const x=e(`#error-${_}`);x.length&&x.html(`<i class="mgc_alert_circle_line mr-1"></i>${d.errors[_][0]}`)}):v(d.message||"Gagal mengupdate user");return}R(d.message||"User berhasil diupdate","Berhasil!").then(()=>{N(),location.reload()})}catch(a){console.error("Error:",a),v("Terjadi kesalahan saat menyimpan user")}finally{c.prop("disabled",!1),c.html(b)}});e(document).ready(function(){E(),j(),P()});
