import{$ as t}from"./jquery-2823516c.js";import{a as X,b as d}from"./gridjs.module-3ea5c5ab.js";import{s as B}from"./index-88056f3d.js";import{t as W}from"./tippy.all-093076db.js";import{s as x,d as p,c as Y,b as $}from"./notification-0e55581f.js";import{f as K}from"./index-a4e39586.js";import"./_commonjsHelpers-725317a4.js";import"./parse-c3570fb2.js";import"./pembayaran-edit-5f085df9.js";let C=null,H=[],m=[];function z(){return[{id:"checkbox",name:d("div",{innerHTML:'<input type="checkbox" id="headerCheck" class="form-checkbox rounded text-primary">'}),width:"50px",sort:!1,formatter:e=>d("div",{innerHTML:e})},{id:"number",name:"#",width:"50px"},{id:"payment_number",name:"Payment Number",width:"130px",formatter:e=>d("div",{innerHTML:e})},{id:"po_number",name:"No PO",width:"130px",formatter:e=>d("div",{innerHTML:`<span class="font-semibold text-primary">${e}</span>`})},{id:"item_desc",name:"Deskripsi Item",width:"200px",formatter:e=>d("div",{innerHTML:e})},{id:"unit_price",name:"Harga Unit",width:"120px",formatter:e=>d("div",{innerHTML:`<span class="font-semibold text-slate-700 dark:text-slate-300">${e}</span>`})},{id:"qty",name:"Qty",width:"70px",formatter:e=>d("div",{innerHTML:`<span class="font-semibold text-center block">${e}</span>`})},{id:"amount",name:"Amount",width:"130px",formatter:e=>d("div",{innerHTML:`<span class="font-semibold text-green-600 dark:text-green-400">${e}</span>`})},{id:"invoice_submit",name:"Tgl Invoice",width:"110px",formatter:e=>d("div",{innerHTML:e})},{id:"payment_date",name:"Tgl Pembayaran",width:"120px",formatter:e=>d("div",{innerHTML:e})},{id:"sla_payment",name:"SLA",width:"80px",formatter:e=>d("div",{innerHTML:e})},{id:"created_by",name:"Dibuat Oleh",width:"120px",formatter:e=>d("div",{innerHTML:e})}]}function L(e=!1){t.ajax({url:B("pembayaran.data"),method:"GET",beforeSend:function(){e&&x("Memuat data...","info",1e3)},success:function(a){H=a;const n=a.map(i=>[`<input type="checkbox" class="form-checkbox rounded text-primary" value="${i.id}">`,i.number,i.payment_number,`<span class="font-semibold text-primary">${i.po_number}</span>`,i.item_desc,i.unit_price,i.qty,i.amount,i.invoice_submit,i.payment_date,i.sla_payment,i.created_by]);C?C.updateConfig({data:n}).forceRender():C=new X({columns:z(),data:n,sort:!0,pagination:{enabled:!0,limit:10},search:!0,className:{table:"table-auto w-full",thead:"bg-slate-100 dark:bg-slate-800",th:"px-4 py-3 text-left text-xs font-medium text-slate-700 dark:text-slate-300",td:"px-4 py-3 text-sm text-slate-900 dark:text-slate-100"}}).render(document.getElementById("table-pembayaran")),Q(a),t("#headerCheck").prop("checked",!1),t("#btn-delete-selected").addClass("hidden"),t("#delete-count").text(0),setTimeout(()=>{W("[data-tippy-content]",{arrow:!0,placement:"top"}),U()},100),e&&x("Data berhasil dimuat!","success",1500)},error:function(){p("Gagal memuat data pembayaran","Error!")}})}function Q(e){const a=e.length,n=e.filter(l=>l.payment_date&&l.payment_date!=="-").length,i=a-n,c=new Date,o=new Date(c.getTime()-30*24*60*60*1e3),s=e.filter(l=>{if(!l.payment_date||l.payment_date==="-")return!1;const b=l.payment_date.split("-");if(b.length!==3)return!1;const y=parseInt(b[0]),G=b[1],_=parseInt(b[2]),A={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11}[G];if(A===void 0)return!1;const J=_>50?1900+_:2e3+_,E=new Date(J,A,y);return E>=o&&E<=c}).length;t("#stat-total").text(a),t("#stat-paid").text(n),t("#stat-pending").text(i),t("#stat-recent").text(s),N()}function U(){t(document).off("change","#headerCheck").on("change","#headerCheck",function(){const e=t(this).is(":checked");t(".form-checkbox").not("#headerCheck").prop("checked",e).trigger("change")}),t(document).off("change",".form-checkbox").on("change",".form-checkbox",function(){if(t(this).is("#headerCheck"))return;V();const e=t(".form-checkbox").not("#headerCheck").length,a=t(".form-checkbox:checked").not("#headerCheck").length;t("#headerCheck").prop("checked",e>0&&e===a)}),t(document).off("click",".btn-detail-pembayaran").on("click",".btn-detail-pembayaran",function(){const e=t(this).data("id");ee(e)}),t(document).off("click",".btn-delete-pembayaran").on("click",".btn-delete-pembayaran",function(){const e=t(this).data("id"),a=t(this).data("number");R([e],`Apakah Anda yakin ingin menghapus pembayaran "${a}"?`)})}function V(){m=[],t(".form-checkbox:checked").not("#headerCheck").each(function(){m.push(t(this).val())}),N()}function N(){const e=m.length>0;t("#delete-count").text(m.length),e?t("#btn-delete-selected").removeClass("hidden").prop("disabled",!1):t("#btn-delete-selected").addClass("hidden").prop("disabled",!0)}function Z(){N()}function R(e,a="Apakah Anda yakin ingin menghapus data ini?"){m=e,t("#deleteMessage").text(a);const n=t("#deleteModal"),i=t("#deleteModalBackdrop"),c=t("#deleteModalContent");n.removeClass("hidden").css("opacity","1"),requestAnimationFrame(()=>{i.css("opacity","1"),c.css({transform:"scale(1)",opacity:"1"})})}function k(){const e=t("#deleteModalBackdrop"),a=t("#deleteModalContent");e.css("opacity","0"),a.css({transform:"scale(0.95)",opacity:"0"}),setTimeout(()=>{t("#deleteModal").addClass("hidden").css("opacity","0")},300)}function ee(e){const a=H.find(o=>o.id==e);if(!a)return;t("#detailPaymentNumber").text(a.payment_number||"-"),t("#detailPaymentDate").text(a.payment_date||"-"),t("#detailPaymentSLAPayment").text(a.sla_payment||"-"),t("#detailInvoiceNumber").text(a.invoice_number||"-"),t("#detailPONumber").text(a.po_number||"-"),t("#detailPRNumber").text(a.pr_number||"-"),t("#detailCreatedBy").text(a.created_by||"-");const n=t("#detailPembayaranModal"),i=t("#detailPembayaranModalBackdrop"),c=t("#detailPembayaranModalContent");n.removeClass("hidden").css("opacity","1"),requestAnimationFrame(()=>{i.css("opacity","1"),c.css({transform:"scale(1)",opacity:"1"})})}function D(){const e=t("#detailPembayaranModalBackdrop"),a=t("#detailPembayaranModalContent");e.css("opacity","0"),a.css({transform:"scale(0.95)",opacity:"0"}),setTimeout(()=>{t("#detailPembayaranModal").addClass("hidden").css("opacity","0")},300)}function te(){L(!1)}function ae(){t(document).off("click","#btn-refresh").on("click","#btn-refresh",function(){L(!0)})}function ne(){t(document).off("click","#btn-delete-selected").on("click","#btn-delete-selected",function(){if(m.length===0){x("Pilih minimal 1 pembayaran untuk dihapus","warning",2e3);return}R(m,`Apakah Anda yakin ingin menghapus ${m.length} pembayaran?`)}),t(document).off("click","#deleteModalConfirm").on("click","#deleteModalConfirm",async function(){var n;const e=t(this),a=e.text();e.prop("disabled",!0).text("Menghapus...");try{await t.ajax({url:B("pembayaran.bulk-destroy"),method:"DELETE",data:{ids:m},headers:{"X-CSRF-TOKEN":t('meta[name="csrf-token"]').attr("content")}}),k(),x("Pembayaran berhasil dihapus!","success",2e3),m=[],Z(),setTimeout(()=>L(!1),500)}catch(i){p(((n=i==null?void 0:i.responseJSON)==null?void 0:n.message)||"Gagal menghapus pembayaran","Gagal!")}finally{e.prop("disabled",!1).text(a)}}),t(document).off("click","#deleteModalCancel, #deleteModalClose").on("click","#deleteModalCancel, #deleteModalClose",k),t(document).off("click","#deleteModal").on("click","#deleteModal",function(e){t(e.target).is("#deleteModal")&&k()}),t(document).off("keydown.pembayaran-delete").on("keydown.pembayaran-delete",function(e){e.key==="Escape"&&!t("#deleteModal").hasClass("hidden")&&k()})}function ie(){t(document).off("click","#detailPembayaranModalClose").on("click","#detailPembayaranModalClose",D),t(document).off("click","#detailPembayaranModal").on("click","#detailPembayaranModal",function(e){t(e.target).is("#detailPembayaranModal")&&D()}),t(document).off("keydown.pembayaran-detail").on("keydown.pembayaran-detail",function(e){e.key==="Escape"&&!t("#detailPembayaranModal").hasClass("hidden")&&D()})}let oe=0,h=[],f=[],P=!1;function v(e){if(e==null||e==="")return"-";const a=Number(e)||0;return new Intl.NumberFormat("id-ID").format(a)}function q(e,a){if(!e||!a)return 0;const n=new Date(e),i=new Date(a);if(n.setHours(0,0,0,0),i.setHours(0,0,0,0),i<n)return 0;let c=0;const o=new Date(n);for(;o<=i;){const s=o.getDay();s!==0&&s!==6&&c++,o.setDate(o.getDate()+1)}return c}function j(){t("#form-create-pembayaran").length&&(ce(),de(),xe())}function ce(){t(document).on("click",".pembayaran-btn-remove-item",function(){const e=t(this).closest("tr");e.find(".pembayaran-invoice-id").val();const a=e.attr("data-row-id"),n=f.findIndex(i=>i.rowId===a);n!==-1&&(f[n].instance&&f[n].instance.destroy(),f.splice(n,1)),e.remove(),S(),O(),h.length>0&&M(h)}),se(),t(document).on("click","#btn-delete-selected-items",function(){re()}),ke()}function se(){t(document).off("change","#item-select-all").on("change","#item-select-all",function(){t(".item-checkbox").prop("checked",this.checked),w()}),t(document).off("change",".item-checkbox").on("change",".item-checkbox",function(){const e=t(".item-checkbox").length===t(".item-checkbox:checked").length;t("#item-select-all").prop("checked",e),w()})}function w(){const e=t(".item-checkbox:checked").length,a=t("#btn-delete-selected-items");e>0?(a.removeClass("hidden"),t("#selected-items-count").text(e)):a.addClass("hidden")}async function re(){const e=t(".item-checkbox:checked").closest("tr"),a=e.length;if(a===0){p("Tidak ada item yang dipilih");return}await Y(`Apakah Anda yakin ingin menghapus ${a} item terpilih?`,"Konfirmasi Hapus")&&(e.each(function(){const i=t(this).attr("data-row-id"),c=f.findIndex(o=>o.rowId===i);c!==-1&&(f[c].instance&&f[c].instance.destroy(),f.splice(c,1))}),e.remove(),S(),t("#item-select-all").prop("checked",!1),w(),O(),h.length>0&&M(h),$(`${a} item berhasil dihapus`))}function de(){t(document).off("click","#btn-pick-invoice").on("click","#btn-pick-invoice",async function(){await le(),fe()}),t(document).off("click","#btn-close-invoice-modal").on("click","#btn-close-invoice-modal",function(){F()}),t(document).off("click",".btn-select-invoice").on("click",".btn-select-invoice",function(e){e.preventDefault(),e.stopPropagation();const a=t(this);if(a.prop("disabled"))return;a.prop("disabled",!0);const n=a.data("invoice-id"),i=h.find(c=>c.id==n);i&&(be(i),F()),setTimeout(()=>a.prop("disabled",!1),500)})}let T=[],r=1,g=10,u=[];async function le(){try{const e=await fetch("/invoice/pembayaran/get-invoices",{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}});if(!e.ok)throw new Error("Gagal memuat data invoice");const a=await e.json();h=a,M(a)}catch(e){console.error("Error loading invoices:",e),p("Gagal memuat data invoice")}}function M(e){T=e;const a=[];if(t("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const n=t(this).val(),i=Number(n);!Number.isNaN(i)&&i>0&&a.push(i)}),u=e.filter(n=>!a.includes(n.id)),r=1,t("#invoice-total").text(u.length),!u.length){t("#invoice-list-body").html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang tersedia atau semua sudah ditambahkan
                </td>
            </tr>
        `);return}I(r),ue(),pe()}function I(e){const a=(e-1)*g,n=a+g,i=u.slice(a,n),c=t("#invoice-list-body");if(c.empty(),!i.length){c.html(`
            <tr>
                <td colspan="8" class="px-3 py-4 text-center text-gray-500">
                    Tidak ada invoice yang cocok dengan pencarian
                </td>
            </tr>
        `);return}i.forEach(o=>{const s=`
            <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/30">
                <td class="px-3 py-2 text-left">
                    <span class="font-medium text-blue-600 dark:text-blue-400">${o.invoice_number}</span>
                </td>
                <td class="px-3 py-2 text-left">${o.po_number}</td>
                <td class="px-3 py-2 text-left">${o.pr_number}</td>
                <td class="px-3 py-2 text-left text-xs">${o.item_desc}</td>
                <td class="px-3 py-2 text-right">${v(o.unit_price)}</td>
                <td class="px-3 py-2 text-center">${o.quantity??"-"}</td>
                <td class="px-3 py-2 text-right font-semibold">${v(o.amount)}</td>
                <td class="px-3 py-2 text-center">
                    <button type="button" class="btn-select-invoice btn btn-sm bg-primary text-white hover:bg-primary-600"
                        data-invoice-id="${o.id}">
                        <i class="mgc_check_line me-1"></i>Pilih
                    </button>
                </td>
            </tr>
        `;c.append(s)}),t("#invoice-count").text(i.length),me()}function me(){const e=Math.ceil(u.length/g)||1;t("#invoice-current-page").text(r),t("#invoice-total-pages").text(e),t("#invoice-per-page").text(g),t("#btn-invoice-prev").prop("disabled",r<=1),t("#btn-invoice-next").prop("disabled",r>=e)}function ue(){t(document).off("input","#invoice-search-input").on("input","#invoice-search-input",function(){const e=t(this).val().toLowerCase().trim(),a=[];t("#pembayaran-items-container .pembayaran-invoice-id").each(function(){const n=t(this).val(),i=Number(n);!Number.isNaN(i)&&i>0&&a.push(i)}),e===""?u=T.filter(n=>!a.includes(Number(n.id))):u=T.filter(n=>a.includes(Number(n.id))?!1:(n.invoice_number||"").toLowerCase().includes(e)||(n.po_number||"").toLowerCase().includes(e)||(n.pr_number||"").toLowerCase().includes(e)||(n.item_desc||"").toLowerCase().includes(e)),r=1,t("#invoice-total").text(u.length),I(r)})}function pe(){t(document).off("click","#btn-invoice-prev").on("click","#btn-invoice-prev",function(){r>1&&(r--,I(r))}),t(document).off("click","#btn-invoice-next").on("click","#btn-invoice-next",function(){const e=Math.ceil(u.length/g);r<e&&(r++,I(r))})}function fe(){t("#modal-pick-invoice").removeClass("hidden")}function F(){t("#modal-pick-invoice").addClass("hidden")}function be(e){t("#pembayaran-items-container tr.text-center.text-gray-500").remove();const a=[];if(t("#pembayaran-items-container tr.pembayaran-item-row .pembayaran-invoice-id").each(function(){const n=t(this).val(),i=Number(n);!Number.isNaN(i)&&i>0&&a.push(i)}),a.includes(Number(e.id))){p("Invoice ini sudah ditambahkan");return}he(e),M(h),S(),t("#item-select-all").prop("checked",!1),w(),$(`Invoice ${e.invoice_number} berhasil ditambahkan`)}function he(e){const a=t("#pembayaran-item-row-template").html(),n=t(a),i=oe++,c="row-"+i;n.attr("data-row-id",c),n.find("input, select").each(function(){const s=t(this).attr("name");s&&t(this).attr("name",s.replace("[0]",`[${i}]`))}),t("#pembayaran-items-container").append(n),n.find(".pembayaran-invoice-id").val(e.id),n.find(".pembayaran-invoice-number").text(e.invoice_number),n.find(".pembayaran-po-number").text(e.po_number),n.find(".pembayaran-pr-number").text(e.pr_number),n.find(".pembayaran-item-desc").text(e.item_desc),n.find(".pembayaran-unit-price").text(v(e.unit_price)),n.find(".pembayaran-qty").text(e.quantity),n.find(".pembayaran-amount").text(v(e.amount)),e.submitted_at&&(n.find(".pembayaran-submitted-at").val(e.submitted_at),n.find(".pembayaran-submitted-date").text(ye(e.submitted_at)));const o=t("#payment_date").val();if(o&&e.submitted_at){const s=q(e.submitted_at,o);n.find(".pembayaran-sla-display").text(s+" hari"),n.find(".pembayaran-sla-input").val(s)}}function ye(e){if(!e)return"-";const a=new Date(e),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],i=a.getDate(),c=n[a.getMonth()],o=a.getFullYear().toString().substr(-2);return`${i}-${c}-${o}`}function S(){t("#pembayaran-items-container tr.pembayaran-item-row").each(function(e){t(this).find(".pembayaran-item-number").text(e+1),t(this).find("input, select, textarea").each(function(){const a=t(this).attr("name");if(!a)return;const n=a.replace(/items\[\d+\]/,`items[${e}]`);t(this).attr("name",n)})})}function O(){if(t("#pembayaran-items-container tr").not(".text-center.text-gray-500").length===0){const a=`
            <tr class="text-center text-gray-500">
                <td colspan="12" class="border px-4 py-8">
                    <div class="flex flex-col items-center gap-2">
                        <i class="mgc_inbox_line text-4xl text-gray-400"></i>
                        <p class="text-sm">Belum ada invoice yang dipilih</p>
                        <p class="text-xs text-gray-400">Klik tombol "Pilih Invoice" untuk memulai</p>
                    </div>
                </td>
            </tr>
        `;t("#pembayaran-items-container").html(a)}}function xe(){const e=document.getElementById("payment_date");e&&K(e,{altInput:!0,altFormat:"d-M-y",dateFormat:"Y-m-d",allowInput:!0,locale:{firstDayOfWeek:1},onChange:function(a,n){ge()}})}function ge(){const e=t("#payment_date").val();if(!e){t(".pembayaran-sla-display").text("-"),t(".pembayaran-sla-input").val("");return}t("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const a=t(this),n=a.find(".pembayaran-submitted-at").val();if(n){const i=q(n,e);a.find(".pembayaran-sla-display").text(i+" hari"),a.find(".pembayaran-sla-input").val(i)}else a.find(".pembayaran-sla-display").text("-"),a.find(".pembayaran-sla-input").val("")})}function ke(){t("#form-create-pembayaran").off("submit").on("submit",async function(e){if(e.preventDefault(),P)return console.log("Form is already being submitted..."),!1;if(!ve())return!1;P=!0;const a=new FormData(this),n=t("#payment_number").val(),i=t("#payment_date").val();t("#pembayaran-items-container tr.pembayaran-item-row").each(function(){const b=(t(this).find(".pembayaran-invoice-id").attr("name")||"").match(/items\[(\d+)\]/),y=b?b[1]:null;y!==null&&(n&&a.set(`items[${y}][payment_number]`,n),a.set(`items[${y}][payment_date]`,i))});const c=t(this).find('button[type="submit"]'),o=c.html();c.prop("disabled",!0).html('<i class="mgc_loading_line animate-spin me-2"></i>Menyimpan...');try{const s=await fetch(this.action,{method:"POST",body:a,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}),l=await s.json();if(!s.ok)throw new Error(l.message||"Gagal menyimpan pembayaran");$(l.message||"Pembayaran berhasil disimpan"),setTimeout(()=>{window.location.href="/invoice/pembayaran"},1e3)}catch(s){p(s.message),c.prop("disabled",!1).html(o),P=!1}})}function ve(){if(t("#pembayaran-items-container tr.pembayaran-item-row").length===0)return p("Belum ada invoice yang dipilih. Silakan pilih minimal 1 invoice."),!1;const a=t("#payment_date").val();return!a||a.trim()===""?(p("Payment Date wajib diisi"),t("#payment_date").focus(),!1):!0}t(document).ready(function(){j()});function we(){const e=document.getElementById("payment_date");e&&typeof flatpickr<"u"&&flatpickr(e,{enableTime:!1,dateFormat:"Y-m-d",locale:"id"})}function Ie(){const e=document.getElementById("pembayaranForm");e&&e.addEventListener("submit",function(a){a.preventDefault();const n=new FormData(this),i=this.querySelector('button[type="submit"]'),c=i.textContent;i.disabled=!0,i.textContent="Menyimpan...",fetch(this.action,{method:"POST",body:n,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(o=>o.ok?o.json():o.json().then(s=>{throw{status:o.status,data:s}})).then(o=>{x("Pembayaran berhasil diperbarui","success"),setTimeout(()=>{window.location.href="/pembayaran"},1e3)}).catch(o=>{let s="Terjadi kesalahan saat memperbarui pembayaran";o.data&&(o.data.message?s=o.data.message:o.data.errors&&(s=Object.values(o.data.errors).flat().join(", "))),p(s),i.disabled=!1,i.textContent=c})})}function Me(){we(),Ie()}t(document).ready(function(){const e=document.getElementById("form-create-pembayaran"),a=document.getElementById("pembayaranForm");e?j():a?Me():document.querySelector("[data-table-init]")&&(te(),ae(),ne(),ie())});
